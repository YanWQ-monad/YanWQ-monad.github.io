<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Hackergame 2021 Personal Write-up · Monad's Blog</title><meta name="description" content="Hackergame 2021 Personal Write-up - Monad"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/favicon.png"><link rel="preload" href="/css/apollo.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/apollo.css"></noscript><link rel="preload" href="/katexify/katex.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/katexify/katex.min.css"></noscript><link rel="preload" href="/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/all.min.css"></noscript><link rel="search" type="application/opensearchdescription+xml" href="https://blog.monadx.com/atom.xml" title="Monad's Blog"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Monad's Blog" type="application/atom+xml">
</head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PP344KH" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrap"><header><a class="logo-link" href="/"><img src="/images/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/YanWQ-monad" target="_blank" rel="noopener">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/about" target="_self">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block" itemscope itemtype="http://schema.org/Article"><h1 class="post-title" itemprop="name">Hackergame 2021 Personal Write-up</h1><div class="hidden" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Monad</span></div><div class="hidden" itemprop="dateModified" content="2023-07-02">2023年7月2日</div><div class="post-info" itemprop="datePublished" content="2021-10-31">2021年10月31日</div><div class="post-content" itemprop="articleBody"><p>这是我个人的 write-up，仅包含我赛时会做的题（其它题看官方题解就好了，没必要再写一遍），记录自己做题时的奇奇怪怪的乱搞方法，仅供参考。</p>
<p>由于我只是个菜鸡，所以解题方法可能会有点绕，<del>可能原理甚至有问题</del>，请大佬原谅我这个菜鸡。</p>
<span id="more"></span>
<h1 id="前言">前言</h1>
<p>谨以此文纪念我参加的第一场 Hackergame。</p>
<figure>
<a href="/images/2021-10-30-Hackergame-2021/ranking.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/ranking.png" alt="" loading="lazy"></a><figcaption>Ranking</figcaption>
</figure>
<p>这次 Hackergame 感觉有比较多的乱搞题（然后才能让我这种乱搞选手能拿到可观的分数）。然后像是比较正经的 binary 题，我是差不多一个都不会做的（比赛结束前 1 天的时候，binary 还是 150）。</p>
<h1 id="目录">目录</h1>
<blockquote>
<p>没有链接样式的都是不会做的，或者是（对于有多个子问题的题目）没有完全做出来的。</p>
</blockquote>
<ul>
<li><a href="#签到">签到</a></li>
<li><a href="#进制十六参上">进制十六——参上</a></li>
<li><a href="#去吧追寻自由的电波">去吧！追寻自由的电波</a></li>
<li><a href="#猫咪问答-pro-max">猫咪问答 Pro Max</a></li>
<li><a href="#卖瓜">卖瓜</a></li>
<li><a href="#透明的文件">透明的文件</a></li>
<li><a href="#旅行照片">旅行照片</a></li>
<li><a href="#flag-助力大红包">FLAG 助力大红包</a></li>
<li>Amnesia
<ul>
<li><a href="#amnesia---轻度失忆">轻度失忆</a></li>
<li>记忆清除</li>
</ul></li>
<li><a href="#图之上的信息">图之上的信息</a></li>
<li><a href="#easy-rsa">Easy RSA</a></li>
<li><a href="#加密的-u-盘">加密的 U 盘</a></li>
<li>赛博厨房
<ul>
<li><a href="#level-0">Level 0</a></li>
<li><a href="#level-1">Level 1</a></li>
<li><a href="#level-2">Level 2</a></li>
<li>Level 3</li>
</ul></li>
<li>灯，等灯等灯
<ul>
<li><a href="#level-0-1">Level 0</a></li>
<li>Level 1</li>
<li>Level 2</li>
</ul></li>
<li>只读文件系统</li>
<li>一石二鸟</li>
<li><a href="#micro-world">Micro World</a></li>
<li>卷王与野生的 GPA</li>
<li><a href="#阵列恢复大师">阵列恢复大师</a>
<ul>
<li><a href="#raid-0">1 - RAID 0</a></li>
<li><a href="#raid-5">2 - RAID 5</a></li>
</ul></li>
<li>链上预言家</li>
<li><a href="#助记词">助记词</a>
<ul>
<li><a href="#第一顿大餐">第一顿大餐</a></li>
<li><a href="#第二顿大餐">第二顿大餐</a></li>
</ul></li>
<li>Co-Program</li>
<li><a href="#马赛克">马赛克</a></li>
<li><a href="#minecraft">minecRaft</a></li>
<li><a href="#密码生成器">密码生成器</a></li>
<li>外星人的音游掌机</li>
<li><a href="#just-be-fun">JUST BE FUN</a></li>
<li>fzuu</li>
<li><a href="#pq">p😭q</a></li>
<li>Make a wish</li>
<li>超 OI 的 Writeup 模拟器</li>
</ul>
<h1 id="签到">签到</h1>
<p>点按钮可以切换 Page，然后不同的 Page 对应不同时间。<br>
并且可以观察到，Page 的 number 就是 Unix 时间戳。<br>
<del>我们不妨大胆猜想</del>，把 Unix 时间戳设置成当前时间，即访问 <code>http://202.38.93.111:10000/?page=1634968833</code>，然后发现就可以获得 Flag。</p>
<h1 id="进制十六参上">进制十六——参上</h1>
<p>观察到右边的 flag 被遮住了，但是左边的 hex 却没有被遮住。所以就可以解析左边的 hex 得到右边的 flag：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">codecs.decode(</span><br><span class="line">    <span class="string">'666c61677b5930555f5348305531445f6b6e30775f4830575f74305f43306e763372745f4845585f746f5f546578547d'</span>,</span><br><span class="line">    <span class="string">'hex'</span>)</span><br></pre></td></tr></tbody></table></figure>
<h1 id="去吧追寻自由的电波">去吧！追寻自由的电波</h1>
<p>下载音频，发现音频播放速度非常快，大概是被暴力压缩了。<br>
我们可以随便找点软件（我用了手边的 iMovie），把音频放慢，就可以听了。</p>
<p>题目云「使用了无线电中惯用的方法来区分字符串中读音相近的字母」，即 <code>e</code> 用 <code>echo</code> 表示，等。 虽然英语听力不太行，但是听首字母还是能勉强听得出来的。</p>
<blockquote>
<p>小彩蛋(?)：把音频放的没那么慢，可以听到女声；再放慢点，就变成了男声，这就说明……（逃）</p>
</blockquote>
<h1 id="猫咪问答-pro-max">猫咪问答 Pro Max</h1>
<blockquote>
<ol type="1">
<li>2017 年，中科大信息安全俱乐部（SEC@USTC）并入中科大 Linux 用户协会（USTCLUG）。目前，信息安全俱乐部的域名（sec.ustc.edu.cn）已经无法访问，但你能找到信息安全俱乐部的社团章程在哪一天的会员代表大会上通过的吗？<br>
提示：输入格式为 YYYYMMDD，如 20211023。请不要回答 “能” 或者 “不能”。</li>
</ol>
</blockquote>
<p>看到「已经无法访问」，直接下意识想到 <a target="_blank" rel="noopener" href="https://web.archive.org">web.archive.org</a>。</p>
<p>在 web archive 里打开 <code>sec.ustc.edu.cn</code>，找到章程，然后就找到其通过日期为 2015 年 5 月 4 日。</p>
<blockquote>
<ol start="2" type="1">
<li>中国科学技术大学 Linux 用户协会在近五年多少次被评为校五星级社团？<br>
提示：是一个非负整数。</li>
</ol>
</blockquote>
<p>查资料无果（可能我姿势不对），先下一题。</p>
<blockquote>
<ol start="3" type="1">
<li>中国科学技术大学 Linux 用户协会位于西区图书馆的活动室门口的牌子上“LUG @ USTC”下方的小字是？<br>
提示：正确答案的长度为 27，注意大小写。</li>
</ol>
</blockquote>
<p><del>经过多次搜索尝试</del>，在 Google 搜索 “LUG USTC” 并切换至“图片”一栏，就可以发现这么一张照片：</p>
<p><a href="/images/2021-10-30-Hackergame-2021/LUG_USTC_Lab.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/LUG_USTC_Lab.png" loading="lazy"></a></p>
<p>即 “Development Team of Library”，刚好是 27 个字。</p>
<blockquote>
<ol start="4" type="1">
<li>在 SIGBOVIK 2021 的一篇关于二进制 Newcomb-Benford 定律的论文中，作者一共展示了多少个数据集对其理论结果进行验证？<br>
提示：是一个非负整数。</li>
</ol>
</blockquote>
<p>搜索 “SIGBOVIK Newcomb-Benford”，然后就能找到一篇论文（集）：<a target="_blank" rel="noopener" href="http://sigbovik.org/2021/proceedings.pdf">SIGBOVIK 2021</a>。</p>
<p>通过目录找到这篇文章，<del>然后仔细阅读，并且与作者友善探讨学术问题（大雾）。</del></p>
<p>实际上通过<del>简单</del>提取，不难发现附录的 figures 都是数据集，一共有 14 - 1 = 13 个</p>
<blockquote>
<ol start="5" type="1">
<li>不严格遵循协议规范的操作着实令人生厌，好在 IETF 于 2021 年成立了 Protocol Police 以监督并惩戒所有违背 RFC 文档的行为个体。假如你发现了某位同学可能违反了协议规范，根据 Protocol Police 相关文档中规定的举报方法，你应该将你的举报信发往何处？<br>
正确答案的长度为 9。</li>
</ol>
</blockquote>
<p>搜索 “IETF Protocol Police”，不难找到 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc8962">RFC 8962</a>。</p>
<p>直接搜索关键词 <code>(e)mail</code> 或 <code>send</code>，不难找到「Send all your reports of possible violations and all tips about wrongdoing to <strong>/dev/null</strong>.」（不得不说，这个玩笑开得真是可以）。</p>
<p>所以答案就是 <code>/dev/null</code>，长度也刚好是 9。</p>
<p>（手动分割线）</p>
<p>然后至此我们找到了 1, 3, 4, 5 的答案，还剩下的第 2 题，可能的答案只有 6 种，手动枚举一下即可（<del>居然是 5 次，我还以为是 0</del>）。</p>
<h1 id="卖瓜">卖瓜</h1>
<p>说实话，我猜不出它（服务器 PHP 代码）是怎么算的，然后就搞不清楚具体是怎么溢出的，<del>但是还是可以瞎试</del>。</p>
<p><del>完了，我忘记我当时是怎么试的了。</del></p>
<p>Update：我想起来了。</p>
<p>首先，盲猜一下数值的范围是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>63</mn></msup></mrow><annotation encoding="application/x-tex">2^{63}</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span> 以内，然后整 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⌊</mo><mfrac><msup><mn>2</mn><mn>63</mn></msup><mn>9</mn></mfrac><mo stretchy="false">⌋</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex"> + 1</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:1.36292em;vertical-align:-0.345em;"></span><span class="mopen">⌊</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01792em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">9</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">⌋</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>（<code>1024819115206086201</code>）个 9 斤的瓜，这样乘一下恰好能超过范围。</p>
<p>提交一下，得到「电子秤上已有 -9223372036854775808/20 斤的瓜」。</p>
<p>再加上 <code>1024819115206086200</code>（比上面少 1）个瓜，就变成了「电子秤上已有 -8/20 斤的瓜」。</p>
<p>接下来再买 <code>1</code> 个 9 斤瓜，再买 <code>1024819115206086201</code> 个，再买 <code>1024819115206086200</code> 个，此时，就有：「电子秤上已有 -7/20 斤的瓜」。</p>
<p>此时再买上 <code>3</code> 个 9 斤瓜，就可以刚好到 20 斤，就「恭喜你逃过一劫！」。</p>
<p><del>上面的操作不能合并，不要问我为什么，我也不知道。我只是瞎试的。</del></p>
<h1 id="透明的文件">透明的文件</h1>
<p>打开文件，发现里面的字符好像 <code>\033</code> 控制符（然后就是缺了 <code>\033</code>）。不妨试试在 <code>[</code> 前都加上 <code>\033</code>（据说 <code>\033</code> 后面一定会接着 <code>[</code>）。</p>
<p>然后打印之，可得：</p>
<p><a href="/images/2021-10-30-Hackergame-2021/transparent_console.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/transparent_console.png" loading="lazy"></a></p>
<p><del>不难读出</del>，flag 是 <code>flag{abxnniohkalmcowsayfiglet}</code>。</p>
<p>附读取程序：</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buffer[<span class="number">20</span> * <span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    FILE *f = <span class="built_in">fopen</span>(<span class="string">"transparent.txt"</span>, <span class="string">"rb"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fseek</span>(f, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="type">int</span> size = <span class="built_in">ftell</span>(f);</span><br><span class="line">    <span class="built_in">rewind</span>(f);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fread</span>(buffer, <span class="number">1</span>, size, f);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++) {</span><br><span class="line">        <span class="keyword">if</span> (buffer[i] == <span class="string">'['</span>)</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">'\033'</span>);</span><br><span class="line">        <span class="built_in">putchar</span>(buffer[i]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="旅行照片">旅行照片</h1>
<p>读题，发现题目的着重点在 KFC 上，并且其非常近海，猜想符合条件的 KFC 不多。<br>
于是搜索 “海边 KFC”，虽然不能直接找到目标（大概?），但是过半的搜索结果都是关于“秦皇岛”的。<br>
然后打开地图，定位到秦皇岛，查找附近的 KFC，得：</p>
<p><a href="/images/2021-10-30-Hackergame-2021/Qinhuangdao_KFC.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/Qinhuangdao_KFC.png" loading="lazy"></a></p>
<p>发现有一家 KFC 很接近海，打开卫星图模式，并放大观察：</p>
<p><a href="/images/2021-10-30-Hackergame-2021/Qinhuangdao_KFC_satellite.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/Qinhuangdao_KFC_satellite.png" loading="lazy"></a></p>
<p>可以发现停车位对上了，那块覆盖着植被的石头也对上了，<del>虽然 KFC 位置出现了一点偏差，但是不影响做题</del>。</p>
<p>观察原图的停车位方向和阴影方向，不难发现拍摄者面朝<strong>东南</strong>，时间是<strong>傍晚</strong>。</p>
<p>然后打开百度街景（不是广告），观察实地景象。<del>百度街景这都多久没更新了？</del></p>
<p><a href="/images/2021-10-30-Hackergame-2021/Qinhuangdao_dolphinarium.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/Qinhuangdao_dolphinarium.png" loading="lazy"></a></p>
<p><del>虽然没有 KFC</del>，但观察屋顶，还是能确定就是那里的。然后就能确定那三个大字就是「<strong>海豚馆</strong>」。</p>
<p>然后打开 <a target="_blank" rel="noopener" href="https://www.kfc.com.cn/kfccda/storelist/index.aspx">KFC 门店信息查询</a>，定位秦皇岛。<br>
虽然「新澳海底世界甜品餐厅」没有电话，猜测电话跟旁边的「新澳海底世界餐厅餐厅」一样（<strong>0335-7168800</strong>）。</p>
<p>最后还剩下楼层高度，看隔壁楼层数一下，大概是在 <strong>14</strong> 层左右（如果不对就上下多试几层就对了）。</p>
<h1 id="flag-助力大红包">FLAG 助力大红包</h1>
<p>总结题意：你需要用 256 个不同的 /8 IP 地址砍红包（访问对应 URL）。</p>
<p>但是这怎么可能呢，有些 IP 段本来就是有保留用途的，而且时间还限制 10 分钟。</p>
<p><del>经过一番胡思乱想</del>，发现可以通过携带 <code>X-Forwarded-For</code> header 来欺骗，就能轻松砍到 flag。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        r = requests.post(</span><br><span class="line">            <span class="string">'http://202.38.93.111:10888/invite/...'</span>,</span><br><span class="line">            data={ <span class="string">'ip'</span>: <span class="string">f'<span class="subst">{i}</span>.1.1.1'</span> },</span><br><span class="line">            headers={ <span class="string">'X-Forwarded-For'</span>: <span class="string">f'<span class="subst">{i}</span>.1.1.1'</span> })</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'助力成功！'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f'Success <span class="subst">{i}</span>'</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">'操作速度太快了'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f'Too fast, sleep'</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></tbody></table></figure>
<h1 id="amnesia---轻度失忆">Amnesia - 轻度失忆</h1>
<p><code>.data</code> 段没了，字符串常量是储存在这里的。既然不能用字符串常量，就分割成字符就可以了。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> {</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'H'</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'e'</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'l'</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'l'</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'o'</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">','</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">' '</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'w'</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'o'</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'r'</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'l'</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'d'</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">'!'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="图之上的信息">图之上的信息</h1>
<p>经过简单尝试（瞎改原请求的参数，然后看错误信息），可以知道 GraphQL 里面有 <code>GUser</code> 类型，其中有 <code>id</code>, <code>username</code> 两个字段。</p>
<p>查 GraphQL 文档，找到“内省”部分，可以用如下代码获取 <code>GUser</code> 的所有字段：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{ "query": "{ __type(name: \"GUser\") { name, fields { name }}}"}</span><br></pre></td></tr></tbody></table></figure>
<p>得到其所有字段：<code>id</code>, <code>username</code>, <code>privateEmail</code>。</p>
<p>再查询 <code>id</code> 为 1 的 admin 用户的 <code>privateEmail</code> 即可：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{ "query": "{ user(id: 1) { id, username, privateEmail }}" }</span><br></pre></td></tr></tbody></table></figure>
<h1 id="easy-rsa">Easy RSA</h1>
<p>观察代码，我们有三个任务：</p>
<ol type="1">
<li>计算 <code>p</code></li>
<li>通过 <code>value[-1]</code> 反推全部 <code>value</code></li>
<li>通过 <code>value_q</code> 反推 <code>q</code></li>
</ol>
<h2 id="计算-p">1. 计算 <code>p</code></h2>
<p>查找资料，可以找到一个叫“威尔逊定理”的东西，即当 <code>p</code> 为质数的时候，有：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>p</mi><mo>−</mo><mn>2</mn><mo stretchy="false">)</mo><mo stretchy="false">!</mo><mo>≡</mo><mn>1</mn><mspace width="0.5em"></mspace><mo stretchy="false">(</mo><mi mathvariant="normal">mod</mi><mo>⁡</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(p - 2)! 1 ( p)</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">!</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.5em;"></span><span class="mopen">(</span><span class="mop"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">p</span><span class="mclose">)</span></span></span></span></span></p>
<p>则：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo stretchy="false">!</mo><mo>≡</mo><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mn>2</mn><mo stretchy="false">)</mo><mo stretchy="false">!</mo><mo>×</mo><mfrac><mrow><mi>y</mi><mo stretchy="false">!</mo></mrow><mrow><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mn>2</mn><mo stretchy="false">)</mo><mo stretchy="false">!</mo></mrow></mfrac><mo>≡</mo><mfrac><mn>1</mn><mrow><munderover><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mi>y</mi><mo>+</mo><mn>1</mn></mrow><mrow><mi>x</mi><mo>−</mo><mn>2</mn></mrow></munderover><mi>i</mi></mrow></mfrac><mo>≡</mo><munderover><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mi>y</mi><mo>+</mo><mn>1</mn></mrow><mrow><mi>x</mi><mo>−</mo><mn>2</mn></mrow></munderover><mi>i</mi><mi>n</mi><mi>v</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mspace width="1em"></mspace><mo stretchy="false">(</mo><mi mathvariant="normal">mod</mi><mo>⁡</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">y! (x - 2)!   _{i = y + 1}^{x - 2} inv(i) ( x)</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">!</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">!</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.3074399999999997em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">!</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">!</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.601266em;vertical-align:-1.279826em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.1559920000000004em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∏</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">i</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.279826em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.2148900000000005em;vertical-align:-1.4137769999999998em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8011130000000006em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mop"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span></span></p>
<p>代码：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_p</span>(<span class="params">x, y</span>):</span><br><span class="line">    mul = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(y + <span class="number">1</span>, x - <span class="number">2</span> + <span class="number">1</span>):</span><br><span class="line">        mul = mul * <span class="built_in">pow</span>(i, x, x - <span class="number">2</span>) % x</span><br><span class="line">    <span class="keyword">return</span> mul</span><br></pre></td></tr></tbody></table></figure>
<h2 id="反推-value">2. 反推 <code>value</code></h2>
<p>这个部分涉及到一个最主要的函数就是 <code>sympy.nextprime</code>，先看看它的文档：</p>
<blockquote>
<p><code>def nextprime(n, ith = 1)</code><br>
Return the ith prime greater than n.<br>
See Also: prevprime: Return the largest prime smaller than n.</p>
</blockquote>
<p>……我感觉官方文档都告诉你应该怎么做了。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_first_value</span>(<span class="params">last_value</span>):</span><br><span class="line">    val = last_value</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        val = sympy.prevprime(val)</span><br><span class="line">    <span class="keyword">return</span> val</span><br></pre></td></tr></tbody></table></figure>
<h2 id="反推原始-q">3. 反推原始 <code>q</code></h2>
<p>这个部分就是给出这个式子（我们把这个原始的 <code>q</code> 称为 <code>x</code>）：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>≡</mo><msup><mi>x</mi><mi>e</mi></msup><mspace width="0.5em"></mspace><mo stretchy="false">(</mo><mi mathvariant="normal">mod</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">q x^e ( n)</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.65819em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">e</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.5em;"></span><span class="mopen">(</span><span class="mop"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>已知 <code>e</code>, <code>n</code>, <code>q</code>，求 <code>x</code>。</p>
<p><del>然而我不会求</del>，查资料，发现了这个：<a target="_blank" rel="noopener" href="https://math.stackexchange.com/questions/2073284/finding-the-kth-root-modulo-m">Finding the k-th root modulo m</a>，简直完美。</p>
<p>按照这篇文章（回答）所说，首先求满足这一式子的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">u</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span></span>：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mtext> </mtext><mi>e</mi><mo>−</mo><mi>v</mi><mtext> </mtext><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">u , e - v , (n) = 1</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">u</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">φ</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span></p>
<p>显然 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>gcd</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>e</mi><mo separator="true">,</mo><mtext> </mtext><mi>φ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">(e, , (n)) = 1</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop"><span style="margin-right:0.01389em;">g</span>cd</span><span class="mopen">(</span><span class="mord mathdefault">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">φ</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，这一步可以用 exgcd 做。</p>
<p>求出来了之后，就有</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>≡</mo><mo stretchy="false">(</mo><msup><mi>b</mi><mi>u</mi></msup><msup><mo stretchy="false">)</mo><mi>e</mi></msup><mspace width="0.5em"></mspace><mo stretchy="false">(</mo><mi mathvariant="normal">mod</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">x (b</annotation></semantics></math><sup>u)</sup>e ( n)</span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.46375em;vertical-align:0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">e</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.5em;"></span><span class="mopen">(</span><span class="mop"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>写成代码，就是：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里的 n 我们通过 `first_value` 生成</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_original_q</span>(<span class="params">e, q, first_value</span>):</span><br><span class="line">    value = [ first_value ]</span><br><span class="line">    n = first_value</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        value.append(sympy.nextprime(value[i - <span class="number">1</span>]))</span><br><span class="line">        n *= value[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这样求 phi 可以快不少，该函数要求 factors 中的 keys 都是质数。</span></span><br><span class="line">    factors = { v: <span class="number">1</span> <span class="keyword">for</span> v <span class="keyword">in</span> value }</span><br><span class="line">    pn = sympy.ntheory.factor_.totient._from_factors(factors)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ex-GCD, 其中 h = gcd(e, pn)；u, v 含义如上所述。</span></span><br><span class="line">    (u, v, h) = sympy.polys.polytools.gcdex(e, pn)</span><br><span class="line"></span><br><span class="line">    x = <span class="built_in">pow</span>(q, <span class="built_in">int</span>(u) * e, n)</span><br><span class="line">    <span class="keyword">return</span> x</span><br></pre></td></tr></tbody></table></figure>
<p>经过验证，以上三个脚本算出的结果，代入进源程序中，都可以算出源码中对应的结果。</p>
<h2 id="rsa-解密">4. RSA 解密</h2>
<p>RSA 解密还需要一个数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span>（含义请自行翻看 RSA 文档，也可以看<a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html">这篇</a>）。</p>
<p>这个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span> 需要满足以下式子：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>d</mi><mo>≡</mo><mn>1</mn><mspace width="0.5em"></mspace><mo stretchy="false">(</mo><mi mathvariant="normal">mod</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">ed 1 ( n)</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.5em;"></span><span class="mopen">(</span><span class="mop"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>在先进的 <code>Python 3.8+</code> 中，可以直接用 <code>pow(x, -1, mod)</code> 来算逆元，省事不少。</p>
<p>于是解密部分的代码：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pn = sympy.ntheory.factor_.totient._from_factors({ p: <span class="number">1</span>, q: <span class="number">1</span> })  <span class="comment"># phi(n)</span></span><br><span class="line"></span><br><span class="line">d = <span class="built_in">pow</span>(e, -<span class="number">1</span>, pn)</span><br><span class="line"></span><br><span class="line">c = <span class="number">110644875422336073.</span>..</span><br><span class="line">m = <span class="built_in">pow</span>(c, d, p * q)</span><br><span class="line"><span class="built_in">print</span>(m)</span><br><span class="line"><span class="built_in">print</span>(m.to_bytes(<span class="number">32</span>, <span class="string">'big'</span>))</span><br></pre></td></tr></tbody></table></figure>
<p>然后就可以拿到 flag 了。</p>
<h1 id="加密的-u-盘">加密的 U 盘</h1>
<p>通过查询 LUKS 的使用文档，可以发现其可以使用密码或 keyfile 加密，于是大胆猜测改密码不会改变 keyfile 一类的东西（注：实际上是 master key 不会变）。</p>
<p>首先使用 <code>losetup -P /dev/loop1 day1.img</code> 将镜像挂载至 loopback（day2 同理）。</p>
<p>然后用 <code>cryptsetup luksDump --dump-master-key /dev/loop1p1</code> dump 出 master key。<code>MK dump</code> 里就是 master key。并用 <code>xxd</code> 或其它工具将 master key 写入文件。</p>
<p><a href="/images/2021-10-30-Hackergame-2021/Luks_masterkey_dump.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/Luks_masterkey_dump.png" loading="lazy"></a></p>
<p>接着用 master key 打开 <code>day2.img</code> 即可：<code>sudo cryptsetup luksOpen --master-key-file &lt;key file&gt; /dev/loop2p1 day2</code>。</p>
<p>最后把 <code>/dev/mapper/day2</code> mount 一下就能读出 <code>flag.txt</code> 了。</p>
<h1 id="赛博厨房">赛博厨房</h1>
<h2 id="level-0">Level 0</h2>
<p>写 4 个程序，针对不同菜谱执行不同程序即可。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">向右 x 步</span><br><span class="line">拿起 1 个物品</span><br><span class="line">向下 1 步</span><br><span class="line">向左 x 步</span><br><span class="line">放下 1 个物品</span><br><span class="line">向上 1 步</span><br><span class="line">向右 y 步</span><br><span class="line">拿起 1 个物品</span><br><span class="line">向下 1 步</span><br><span class="line">向左 y 步</span><br><span class="line">放下 1 个物品</span><br></pre></td></tr></tbody></table></figure>
<p>自行修改 <code>x</code>, <code>y</code> = <code>1</code> or <code>2</code> 来控制不同菜谱即可。</p>
<h2 id="level-1">Level 1</h2>
<p>写个简单循环，把物品不断放到锅中即可。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">向右 1 步</span><br><span class="line">拿起 100 个物品</span><br><span class="line">向下 1 步</span><br><span class="line">向左 1 步</span><br><span class="line">放下 1 个物品</span><br><span class="line">如果手上的物品大于等于 1 向上跳转 1 行</span><br></pre></td></tr></tbody></table></figure>
<h2 id="level-2">Level 2</h2>
<p>写 32 个程序，第 i 个程序分对应 <code>[0, 0, 0, 0, 0, i]</code> 这个菜谱。 然后再额外加一个程序，写 <code>向右 {} 步</code>，然后枚举数字，撞 hash（实际上是两个 sha256 和一个 arc4 随机?）。</p>
<p>暴力代码见：<a target="_blank" rel="noopener" href="https://gist.github.com/YanWQ-monad/4febc8f8635514459a981adfefb1b9f1">GitHub Gist 4febc8f</a>。</p>
<h1 id="灯等灯等灯">灯，等灯等灯</h1>
<h2 id="level-0-1">Level 0</h2>
<p>解一个线性方程组即可。代码过丑就不放了（逃）。</p>
<p><del>我发现我不会写 % 256 意义下的高斯消元，于是我就直接用 Python 高精度，解完再取模。</del></p>
<p><del>然后我解完之后，没有去研究提交的 HTTP API，直接就写了个程序模拟鼠标点击（逃）</del></p>
<h1 id="micro-world">Micro World</h1>
<p><del>随便乱瞅一下（我不会告诉你我走了多少弯路的）</del>，能发现这个程序是用 pyinstaller 生成的。</p>
<p>然后就找一个 pyinstaller unpacker（我用的是 <a target="_blank" rel="noopener" href="https://github.com/extremecoders-re/pyinstxtractor">extremecoders-re/pyinstxtractor</a>），然后就可以发现一个 <code>2.pyc</code> 文件。用 <code>pip</code> 安装 <code>pygame</code> 后，发现可以直接用 <code>python 2.pyc</code> 运行，能确定提取出了正确的东西。</p>
<p>接着继续尝试反编译，我这里找了 <a target="_blank" rel="noopener" href="https://github.com/zrax/pycdc">zrax/pycdc</a>，能够逆向 Python 3.9 的字节码，但不完全能逆向出来（但是至少能看到大致的逻辑，也能看到点的数据）。</p>
<p><a href="/images/2021-10-30-Hackergame-2021/microworld_decompile.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/microworld_decompile.png" loading="lazy"></a></p>
<p>这是 <code>2.pyc</code> 中 <code>Point</code> 的定义：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, pos, vx, vy</span>):</span><br><span class="line">        (self.x, self.y) = pos</span><br><span class="line">        self.vx = vx</span><br><span class="line">        self.vy = vy</span><br></pre></td></tr></tbody></table></figure>
<p>不难猜出，<code>vx</code> 和 <code>vy</code> 就是这个点的移动速度（也就是 <code>list_</code> 每个元素的后两个值）。显然，只要把这个速度取相反数就可以还原出原 flag 图案了（显然碰撞是可逆的）。</p>
<p>然而我并不想对着 bytecode 翻译一遍代码，所以我决定动态“注入”到 <code>2.pyc</code> 里面改变量。下面我们先把 <code>2.pyc</code> 重命名成 <code>w2.pyc</code>，因为不能直接 <code>import 2</code>。</p>
<p>但是 <code>import w2</code> 后，<code>import</code> 没返回，窗口已经运行了，有点难改变量。<del>下面开始乱搞！</del></p>
<p>我们可以新建一个 <code>pygamx.py</code> 来 mock <code>pygame</code>，然后修改 <code>2.pyc</code> 的 bytecode：暴力把 <code>pygame</code> 改成 <code>pygamx</code>（暴力替换二进制数据即可）。</p>
<p><code>pygamx.py</code>：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pygame</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Time</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Clock</span>:</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">self</span>):</span><br><span class="line">            self.first = <span class="literal">True</span></span><br><span class="line">            self.clock = pygame.time.Clock()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">tick</span>(<span class="params">self, fps</span>):</span><br><span class="line">            <span class="comment"># 手动控制每一帧</span></span><br><span class="line">            <span class="built_in">input</span>()</span><br><span class="line">            <span class="comment"># self.clock.tick(fps)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.first:</span><br><span class="line">                self.first = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 经过测试，可以在这里反向 import 并访问 Pointlist 而不抛出 AttributeError</span></span><br><span class="line">                <span class="keyword">import</span> w2</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(w2.Pointlist)):</span><br><span class="line">                    p = w2.Pointlist[i]</span><br><span class="line">                    w2.Pointlist[i] = w2.Point((p.x, p.y), -p.vx, -p.vy)</span><br><span class="line"></span><br><span class="line">time = Time()</span><br><span class="line"></span><br><span class="line"><span class="comment"># mock 其它 attribute</span></span><br><span class="line">init = pygame.init</span><br><span class="line">quit = pygame.quit</span><br><span class="line">mixer = pygame.mixer</span><br><span class="line">display = pygame.display</span><br><span class="line">event = pygame.event</span><br><span class="line">draw = pygame.draw</span><br><span class="line">QUIT = pygame.QUIT</span><br></pre></td></tr></tbody></table></figure>
<p>然后经过测试，可以在上面 <code>pygame.time.Clock.tick</code> 里面反向 <code>import w2</code>，修改 <code>list_</code> 和 <code>Pointlist</code>，把速度取反，就可以了。</p>
<p>此时直接运行 <code>python w2.pyc</code>，并且在控制台窗口用回车控制每一帧，看到 flag 差不多展示出来了就行了：</p>
<p><a href="/images/2021-10-30-Hackergame-2021/microworld_flag.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/microworld_flag.png" loading="lazy"></a></p>
<h1 id="阵列恢复大师">阵列恢复大师</h1>
<p><del>数据恢复软件都是浮云，手撕才是正道。</del></p>
<p>当时做题的时候，看着 RAID 5 通过的人比 RAID 0 多，所以就先跑去做 RAID 5 了。后来仔细思索一下，可能是因为 RAID 5 有软件能一键恢复吧。</p>
<h2 id="raid-0">1 - RAID 0</h2>
<p>额，在恢复之前，先来看一下 RAID 0 的结构。</p>
<p><a href="/images/2021-10-30-Hackergame-2021/RAID_0.svg" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/RAID_0.svg" loading="lazy"></a></p>
<p>说白了大概就是按块大小分块，然后按顺序依次存放在各个盘中。所以一个推论就是，一段内容只会出现在一个盘里面。</p>
<p>为了方便起见，先把硬盘名字按照字母序重命名成 1~8.img。</p>
<p>先随便看看这些盘的内容，然后不难发现，8.img 的 0x00000200 处有一个 <code>EFI PART</code>，这是 GPT 分区表的标志。于是就不难推测出 8.img 是第一个盘。</p>
<p><a href="/images/2021-10-30-Hackergame-2021/raid0_disk_8_head.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/raid0_disk_8_head.png" loading="lazy"></a></p>
<p>然后的话，再随便翻翻这些盘的内容，发现似乎空的部分（<code>0x00</code>）比较多。要确定盘的顺序的话，因为块与块之间是直接拼起来的，所以可以直接看内容的连续性来判断块的顺序，进而判断盘的顺序。</p>
<p>这样的话，随便翻看几下，发现 <code>0x008C0000</code> 和 <code>0x008E0000</code> 附近的内容有断层，而且丰富性比较高，有文本、乱码、零。并且从这两个“断层”的距离不难推测出块的大小是 128KB。（注意下面第 4 块盘的 <code>0x008E0000</code> 前的部分，<code>n</code> 后面应该有一个空格。）</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Disk</th>
<th style="text-align: center;"><code>0x008C0000</code> 前</th>
<th style="text-align: center;"><code>0x008C0000</code> 后</th>
<th style="text-align: center;"><code>0x008E0000</code> 前</th>
<th style="text-align: center;"><code>0x008E0000</code> 后</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">0x00000000</td>
<td style="text-align: center;"><code>2J..`...HD.....k</code></td>
<td style="text-align: center;"><code>Subtype /Link /R</code></td>
<td style="text-align: center;">0x00000000</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">0x00000000</td>
<td style="text-align: center;"><code>ect [118.3625 23</code></td>
<td style="text-align: center;"><code>g_system_respons</code></td>
<td style="text-align: center;">0x00000000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">0x00000000</td>
<td style="text-align: center;"><code>iveness_under_lo</code></td>
<td style="text-align: center;"><code>...:......b.&lt;.dL</code></td>
<td style="text-align: center;">0x00000000</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">0x00000000</td>
<td style="text-align: center;"><code>.q,.[.Q..B....Y.</code></td>
<td style="text-align: center;"><code>0470796 00000 n</code></td>
<td style="text-align: center;">0x00000000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;"><code>0 obj.&lt;&lt; /A 489</code></td>
<td style="text-align: center;"><code>..g..b.c.D\...G.</code></td>
<td style="text-align: center;"><code>F.O...\i...o.G..</code></td>
<td style="text-align: center;">0x00000000</td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: center;">0x00000000</td>
<td style="text-align: center;"><code>000 n .000007636</code></td>
<td style="text-align: center;"><code>M.t.p...V+.,=.2.</code></td>
<td style="text-align: center;">0x00000000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">7</td>
<td style="text-align: center;">0x00000000</td>
<td style="text-align: center;"><code>.0000470505 0000</code></td>
<td style="text-align: center;"><code>4....%......,.iI</code></td>
<td style="text-align: center;">0x00000000</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">0x00000000</td>
<td style="text-align: center;"><code>0 R /Border [ 0</code></td>
<td style="text-align: center;"><code>n .0000076610 00</code></td>
<td style="text-align: center;"><code>.0..TL$w.......1</code></td>
</tr>
</tbody>
</table>
<p>根据 RAID 0 的结构，不难推测出 <code>1 - 2</code>，<code>2 - 3</code>，<code>4 - 7</code>，<code>5 - 8</code>，<code>8 - 6</code>（能分成三大块：<code>5 8 6</code>，<code>1 2 3</code>，<code>4 7</code>）。（如果觉得看表难推测的话，可以再看看这些位置的上下文，找一下文本的规律（常见词等）。）</p>
<p>到这里，可能的盘的顺序就只剩下 <code>8 6 1 2 3 4 7 5</code> 和 <code>8 6 4 7 1 2 3 5</code> 两种，已经很优了。如果懒的话，可以直接两种方法都试一下，看看哪种对的就行了。</p>
<p>实际上，在 <code>0x001C0000</code> ~ <code>0x001E0000</code> 的地方，可以观测到内容从有（非 0x00）变无（0x00）：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Disk</th>
<th style="text-align: center;">1</th>
<th style="text-align: center;">2</th>
<th style="text-align: center;">3</th>
<th style="text-align: center;">4</th>
<th style="text-align: center;">5</th>
<th style="text-align: center;">6</th>
<th style="text-align: center;">7</th>
<th style="text-align: center;">8</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Not 0x00?</td>
<td style="text-align: center;">T</td>
<td style="text-align: center;">partial</td>
<td style="text-align: center;">F</td>
<td style="text-align: center;">F</td>
<td style="text-align: center;">F</td>
<td style="text-align: center;">T</td>
<td style="text-align: center;">F</td>
<td style="text-align: center;">T</td>
</tr>
</tbody>
</table>
<p>据此，能推断出第 2 块盘在第 4 个位置。也就是说上面的两个方案，<code>8 6 1 2 3 4 7 5</code> 是对的。</p>
<p>既然顺序和块大小（128 KB）都有了，直接恢复出完整镜像（我用了一下 DiskGenius），然后把镜像挂载一下就行了。</p>
<h2 id="raid-5">2 - RAID 5</h2>
<p>同理，先来看看 RAID 5 的结构。</p>
<p><a href="/images/2021-10-30-Hackergame-2021/RAID_5.svg" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/RAID_5.svg" loading="lazy"></a></p>
<p>与上面 RAID 0 不同的是，它多了一块奇偶校验块。</p>
<p>也像上面一样，先瞅瞅这些盘的头部。</p>
<p><a href="/images/2021-10-30-Hackergame-2021/raid5_disk_23_head.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/raid5_disk_23_head.png" loading="lazy"></a></p>
<p>然后可以发现 2.img 和 3.img 有 GPT 头，故可以确定这两个盘一个是第一个位置，另一个是最后一个位置（首个校验块所在盘）。而且在 2.img 的 <code>0x0040400</code> 的地方可以找到 ext2/3/4 的 superblock。</p>
<p>所以现在就只剩下 12 种方案了……这一次我比较懒，就没有继续了（而且也懒得分析比较复杂的 RAID 5 了）。</p>
<p>然后我真的就去莽了，块大小 64 KB 和 256 KB 都莽一下（不要问我为什么不试 128 KB），再把上面 12 种方案都过一遍。实际操作就是在 DiskGenius 上排顺序，看看那个拼好了之后，DiskGenuis 能找到 ext2/3/4 分区。</p>
<p>最后试了几下，试出来了 <code>2 4 1 5 3</code>（块大小忘了实际上是多少了），然后用 DiskGenius 导出镜像（不知道为啥我那玩意不支持导出大于 1 MB 的文件），然后瞎搞一下，mount 上了就行了。</p>
<p><del>为什么我导出镜像之后还要用 testdisk 找一下分区后，导出分区才能挂载。</del></p>
<h1 id="助记词">助记词</h1>
<p>说句实话，这道题一点也不 math。</p>
<h2 id="第一顿大餐">第一顿大餐</h2>
<p>下载程序源码，打开。</p>
<p>其中 <code>cn.edu.ustc.lug.hack.mnemonic_phrase.Instance</code> 里的 <code>post</code> 是主要逻辑（flag 的处理也在这里），并且<del>不难发现</del>，这个函数里面有一个 for 循环，调试一下，发现每次请求好像只会循环一次。</p>
<p>回头看 HTTP API，发现似乎可以一次性提交一个数组，尝试一下提交 32 个相同的助记词，然后发现正好可以拿到第一个 flag。</p>
<h2 id="第二顿大餐">第二顿大餐</h2>
<p><del>作为一个逆向过 Minecraft 种子生成的人，怎么会止步于此呢</del></p>
<p>观察发现，<code>sleep</code> 函数是在 <code>Phrase.equals</code> 方法中执行的，然后我们并没有在本项目中发现直接调用它的地方。</p>
<p>再思考一下，能发现它会在 <code>Set&lt;Phrase&gt;</code>（实际上是 <code>LinkedHashSet</code>）中被 <code>Set</code> 调用。</p>
<p>第二个 flag 需要卡顿 9 秒，掐指一算，大概需要调用 <code>equals</code> 450 次，大概是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>n</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">n^2</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> 的级别。</p>
<p><del>查看 <code>LinkedHashSet</code> 源代码</del>，猜测一下，我们要构造 <code>hash</code> 相同的 <code>Phrase</code>，让 <code>Set</code> 进行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>n</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">n^2</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> 级别次数的比较。</p>
<p>然后看 <code>Phrase.hash</code> 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> Objects.hash(<span class="built_in">this</span>.text, <span class="built_in">this</span>.time, <span class="built_in">this</span>.user);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>再看 <a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/util/Objects.java#l127"><code>Object.hash</code> 方法</a>：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object... values)</span> {</span><br><span class="line">    <span class="keyword">return</span> Arrays.hashCode(values);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>再看 <a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/be44bff34df4/src/share/classes/java/util/Arrays.java#l4139"><code>Arrays.hashCode</code> 方法</a>：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(Object a[])</span> {</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// 在这个例子中与这个无关</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (Object element : a)</span><br><span class="line">        result = <span class="number">31</span> * result + (element == <span class="literal">null</span> ? <span class="number">0</span> : element.hashCode());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>换句话说，就是分别对 <code>this.text</code>, <code>this.time</code>, <code>this.user</code> 分别调用 <code>.hashCode()</code>，然后再拼在一起。这里先看 <code>this.text</code>（即 <code>String</code>）的 <code>hashCode</code>。</p>
<p><a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/lang/String.java#l1452"><code>String.hashCode</code></a>：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hash;</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; value.length &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="type">char</span> val[] = value;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; value.length; i++)</span><br><span class="line">            h = <span class="number">31</span> * h + val[i];</span><br><span class="line">        hash = h;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这个函数就是首先做了一个缓存，如果 <code>hash</code>（<code>String</code> 的一个 field）存在，就不算了。主要逻辑在 for 循环上。</p>
<p>我们可以把这个算法提取出来，暴力算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>60</mn><msup><mn>0</mn><mn>4</mn></msup></mrow><annotation encoding="application/x-tex">600^4</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">6</span><span class="mord">0</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span> 种 hash（其实也可以双向 BFS，我这里没用）。</p>
<p>下面的暴力代码用 Rust 写，并且进行了一点小优化（因为算 <code>hashCode</code> 的过程是线性的），大概 5 分钟能跑完全部 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>60</mn><msup><mn>0</mn><mn>4</mn></msup></mrow><annotation encoding="application/x-tex">600^4</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">6</span><span class="mord">0</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span> 种 hash：</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"><span class="keyword">use</span> std::num::Wrapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MNEMONICS_TEXTS: [&amp;<span class="type">str</span>; <span class="number">600</span>] = [ ... ];</span><br><span class="line"><span class="keyword">const</span> POW_31: [<span class="type">u32</span>; <span class="number">15</span>] = [ <span class="number">1</span>, <span class="number">31</span>, <span class="number">961</span>, <span class="number">29791</span>, <span class="number">923521</span>, <span class="number">28629151</span>, <span class="number">887503681</span>, <span class="number">1742810335</span>, <span class="number">2487512833</span>, <span class="number">4098453791</span>, <span class="number">2498015937</span>, <span class="number">129082719</span>, <span class="number">4001564289</span>, <span class="number">3789408671</span>, <span class="number">1507551809</span> ];</span><br><span class="line"><span class="comment">// POW_31[i] 记录的是 pow(31, i) 的结果</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Mnemonics</span> {</span><br><span class="line">    pow: <span class="type">u32</span>,</span><br><span class="line">    hash: <span class="type">u32</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">hash_str</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> {</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = <span class="title function_ invoke__">Wrapping</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">c</span> <span class="keyword">in</span> s.<span class="title function_ invoke__">chars</span>() {</span><br><span class="line">        x = x * <span class="title function_ invoke__">Wrapping</span>(<span class="number">31</span>) + <span class="title function_ invoke__">Wrapping</span>(c <span class="keyword">as</span> <span class="type">u32</span>);</span><br><span class="line">    }</span><br><span class="line">    x.<span class="number">0</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Mnemonics</span> {</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(_index: <span class="type">usize</span>, text: &amp;<span class="symbol">'static</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> Mnemonics {</span><br><span class="line">        Mnemonics {</span><br><span class="line">            pow: POW_31[ text.<span class="title function_ invoke__">len</span>() ],</span><br><span class="line">            hash: <span class="title function_ invoke__">hash_str</span>(text),</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">join_hash</span>(ss: &amp;[&amp;Mnemonics]) <span class="punctuation">-&gt;</span> <span class="type">u32</span> {</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = <span class="title function_ invoke__">Wrapping</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">first</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">s</span> <span class="keyword">in</span> ss {</span><br><span class="line">        <span class="keyword">if</span> !first {</span><br><span class="line">            x = x * <span class="title function_ invoke__">Wrapping</span>(<span class="number">31</span>) + <span class="title function_ invoke__">Wrapping</span>(<span class="string">' '</span> <span class="keyword">as</span> <span class="type">u32</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        x = x * <span class="title function_ invoke__">Wrapping</span>(s.pow) + <span class="title function_ invoke__">Wrapping</span>(s.hash);</span><br><span class="line"></span><br><span class="line">        first = <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    x.<span class="number">0</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() {</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mnemonics</span> = Vec::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="title function_ invoke__">for</span> (i, text) <span class="keyword">in</span> MNEMONICS_TEXTS.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() {</span><br><span class="line">        mnemonics.<span class="title function_ invoke__">push</span>(Mnemonics::<span class="title function_ invoke__">new</span>(i, text));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 我们只收集 hashCode 为 [0, 20) 的</span></span><br><span class="line">    <span class="comment">// 这样取是没问题的，假设 hash 足够均匀的话</span></span><br><span class="line">    <span class="keyword">const</span> HASH_RANGE: <span class="type">u32</span> = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span> = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">hash</span> <span class="keyword">in</span> <span class="number">0</span>..HASH_RANGE {</span><br><span class="line">        result.<span class="title function_ invoke__">insert</span>(hash, Vec::<span class="title function_ invoke__">new</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">for</span> (i1, m1) <span class="keyword">in</span> mnemonics.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() {</span><br><span class="line">        <span class="title function_ invoke__">for</span> (i2, m2) <span class="keyword">in</span> mnemonics.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() {</span><br><span class="line">            <span class="title function_ invoke__">for</span> (i3, m3) <span class="keyword">in</span> mnemonics.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() {</span><br><span class="line">                <span class="title function_ invoke__">for</span> (i4, m4) <span class="keyword">in</span> mnemonics.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() {</span><br><span class="line">                    <span class="comment">// 这个 \times 31 下面会提到</span></span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">hash</span> = <span class="title function_ invoke__">join_hash</span>(&amp;[&amp;m1, &amp;m2, &amp;m3, &amp;m4]).<span class="title function_ invoke__">wrapping_mul</span>(<span class="number">31</span>);</span><br><span class="line">                    <span class="keyword">if</span> hash &gt;= HASH_RANGE {</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">plan</span> = [i1, i2, i3, i4];</span><br><span class="line">                    result.<span class="title function_ invoke__">get_mut</span>(&amp;hash).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">push</span>(plan);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"{:?}"</span>, result);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>上面的程序只会输出 <code>hashCode</code> 对应的单词的序号。</p>
<p>再写个程序解析这个输出（把两个程序分开，进行下面的操作的时候就不用重复破解 hash）：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">s = [ ... ]  <span class="comment"># 单词表</span></span><br><span class="line">p = { ... }  <span class="comment"># 上面的输出</span></span><br><span class="line">d = [ ... ]  <span class="comment"># delay，见下面的文字</span></span><br><span class="line"></span><br><span class="line">results = []</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="number">32</span>:</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> p[<span class="number">20</span> - d[i]]:</span><br><span class="line">        results.append(<span class="string">'"{}"'</span>.<span class="built_in">format</span>( <span class="string">' '</span>.join([ s[i] <span class="keyword">for</span> i <span class="keyword">in</span> x ] )))</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &gt;= <span class="number">32</span> <span class="keyword">or</span> d[i - <span class="number">1</span>] != d[i]:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">t = <span class="string">', '</span>.join(results)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f'[<span class="subst">{t}</span>]'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>但是直接把暴力出的结果扔进程序里，发现最多只能卡 3 秒左右，是怎么回事？</p>
<p>我们继续看回去那个加单词的循环，把每一次循环所需的时间输出，就可以发现它的时间是 <code>24 - 49 - 71 - 103 - ... - 254 - 0 - 24 - 47 - ... - 243 - 0 - 23 - ...</code>（数字不是复制的，但是趋势是一样的）。</p>
<p><code>Phrase.hash</code> 是 <code>Objects.hash(this.text, this.time, this.user);</code>，每过一秒，<code>this.time</code> 的变化就会使我们精心构造的 hash 冲突给毁掉。</p>
<p>这个有点难处理，观察回 <code>Arrays.hashCode</code>，我们可以把 <code>this.text.hashCode * 31</code> 后的 hash 缓存起来，每次当 <code>this.time</code> 加一的时候，我们就让 <code>this.text.hashCode * 31</code> 减一。</p>
<p>至于在这个长度为 32 的序列中，应该什么时候减一的这个问题，我也没有好的思路，只是随便试，试了一个相对较好的：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d = [ <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">9</span> ]</span><br></pre></td></tr></tbody></table></figure>
<p>由于实际运行时的微妙时间差（即开始运行的时候，并不是完全正对着每秒的开头的），所以要在在线的网站上多试几次。</p>
<h1 id="马赛克">马赛克</h1>
<p>这道题的简单题意就是，给你一个打了码的二维码，并且给出打码的程序（算法是模糊部分的一个大的 block 的颜色，是这个区域内颜色的平均值）。<del>简单算一下信息量，感觉还是能复原的。</del></p>
<p>一些用词（为了避免混乱所以先说明）：二维码的块：指模糊前的二维码的一个黑白块；码的块：指打码部分的一个色块（应该没毛病吧）。</p>
<p>于是乎，最朴素的方法就是……枚举原二维码每个块的黑白，然后看看跟模糊后的是否一致，但是这样做时间成本太大了。</p>
<p>然后可以发现，这个码的一个块的影响范围是有限的，大概就 10 个左右的二维码块。于是我们就可以针对每个码的块，枚举其下的二维码的黑白。再把每一个块的有效方案拼起来即可。</p>
<p><del>原理听懂了吗？原理大概就这个样子。但是……你发现这个确实并不好实现（大概?）</del></p>
<p>具体实现的话，假设前面处理了若干个块，这些块拼在一起的有效方案（可能有多个）放在一个数组 <code>p</code> 里。然后处理一个新的块的时候，就把当前区域的方案，与 <code>p</code> 中的匹配（能相容的就结合），把新的方案放到一个新的数组 <code>q</code> 供下一轮使用。</p>
<p>具体代码（调试输出十分炫酷，建议运行）：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">X, Y = <span class="number">103</span>, <span class="number">137</span>     <span class="comment"># 马赛克左上角位置(单位为像素)</span></span><br><span class="line">N = <span class="number">20</span>              <span class="comment"># 马赛克块的数量（共N*N块）</span></span><br><span class="line">BOX_SIZE = <span class="number">23</span>       <span class="comment"># 每个马赛克块的大小（边长，单位为像素）</span></span><br><span class="line">PIXEL_SIZE = <span class="number">11</span>     <span class="comment"># 二维码每个块的大小（边长，单位为像素）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_block_color</span>(<span class="params">img, x, y</span>):</span><br><span class="line">    x1 = X + x * BOX_SIZE</span><br><span class="line">    x2 = X + (x + <span class="number">1</span>) * BOX_SIZE</span><br><span class="line">    y1 = Y + y * BOX_SIZE</span><br><span class="line">    y2 = Y + (y + <span class="number">1</span>) * BOX_SIZE</span><br><span class="line">    <span class="keyword">return</span> math.floor(img[x1:x2, y1:y2].mean())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_qr_block_in</span>(<span class="params">mx, my, qx, qy</span>):</span><br><span class="line">    <span class="comment"># 检查 (qx, qy) 这个二维码块 是否影响 (mx, my) 这个打码块</span></span><br><span class="line">    X1 = X + mx * BOX_SIZE</span><br><span class="line">    X2 = X + (mx + <span class="number">1</span>) * BOX_SIZE - <span class="number">1</span></span><br><span class="line">    Y1 = Y + my * BOX_SIZE</span><br><span class="line">    Y2 = Y + (my + <span class="number">1</span>) * BOX_SIZE - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    x1 = qx * PIXEL_SIZE</span><br><span class="line">    x2 = (qx + <span class="number">1</span>) * PIXEL_SIZE - <span class="number">1</span></span><br><span class="line">    y1 = qy * PIXEL_SIZE</span><br><span class="line">    y2 = (qy + <span class="number">1</span>) * PIXEL_SIZE - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (X1 &lt;= x1 &lt;= X2 <span class="keyword">and</span> Y1 &lt;= y1 &lt;= Y2) <span class="keyword">or</span> (X1 &lt;= x1 &lt;= X2 <span class="keyword">and</span> Y1 &lt;= y2 &lt;= Y2) \</span><br><span class="line">    <span class="keyword">or</span> (X1 &lt;= x2 &lt;= X2 <span class="keyword">and</span> Y1 &lt;= y1 &lt;= Y2) <span class="keyword">or</span> (X1 &lt;= x2 &lt;= X2 <span class="keyword">and</span> Y1 &lt;= y2 &lt;= Y2):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">paint_with</span>(<span class="params">img, x, y, color</span>):</span><br><span class="line">    <span class="comment"># 将 (x, y) 二维码块涂成 color 色</span></span><br><span class="line">    x1 = x * PIXEL_SIZE</span><br><span class="line">    x2 = (x + <span class="number">1</span>) * PIXEL_SIZE</span><br><span class="line">    y1 = y * PIXEL_SIZE</span><br><span class="line">    y2 = (y + <span class="number">1</span>) * PIXEL_SIZE</span><br><span class="line">    img[x1:x2, y1:y2] = color</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Plan</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, plan = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> plan <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            plan = {}</span><br><span class="line">        self.plan = plan</span><br><span class="line">        self.min_x = <span class="number">10000</span></span><br><span class="line">        self.min_y = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compatible</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 检查此 plan 是否与 `other` 兼容</span></span><br><span class="line">        <span class="keyword">for</span> (x, y), value <span class="keyword">in</span> self.plan.items():</span><br><span class="line">            <span class="keyword">if</span> (data := other.plan.get((x, y))) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> data != value:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self, x, y, data</span>):</span><br><span class="line">        self.min_x = <span class="built_in">min</span>(self.min_x, x)</span><br><span class="line">        self.min_y = <span class="built_in">min</span>(self.min_y, y)</span><br><span class="line">        self.plan[(x, y)] = data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">combine</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="comment"># 将此 plan 与 `other` 结合，返回新的 plan</span></span><br><span class="line">        <span class="keyword">assert</span> self.compatible(other)</span><br><span class="line">        new = Plan(self.plan.copy())</span><br><span class="line">        <span class="keyword">for</span> (x, y), value <span class="keyword">in</span> other.plan.items():</span><br><span class="line">            new.push(x, y, value)</span><br><span class="line">        <span class="keyword">return</span> new</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_initial_plan</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="comment"># 这是获取初始的 plan，主要包含码周边的一圈二维码块</span></span><br><span class="line"></span><br><span class="line">    X1 = X + <span class="number">0</span> * BOX_SIZE</span><br><span class="line">    X2 = X + N * BOX_SIZE</span><br><span class="line">    Y1 = Y + <span class="number">0</span> * BOX_SIZE</span><br><span class="line">    Y2 = Y + N * BOX_SIZE</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_in</span>(<span class="params">x, y</span>):</span><br><span class="line">        <span class="keyword">return</span> X1 &lt;= x &lt;= X2 <span class="keyword">and</span> Y1 &lt;= y &lt;= Y2</span><br><span class="line"></span><br><span class="line">    plan = Plan()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> x, y <span class="keyword">in</span> np.ndindex(<span class="number">57</span>, <span class="number">57</span>):</span><br><span class="line">        <span class="keyword">for</span> i, j <span class="keyword">in</span> np.ndindex(N, N):</span><br><span class="line">            <span class="keyword">if</span> check_qr_block_in(i, j, x, y):</span><br><span class="line">                x1 = x * PIXEL_SIZE</span><br><span class="line">                x2 = (x + <span class="number">1</span>) * PIXEL_SIZE - <span class="number">1</span></span><br><span class="line">                y1 = y * PIXEL_SIZE</span><br><span class="line">                y2 = (y + <span class="number">1</span>) * PIXEL_SIZE - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> is_in(x1, y1):</span><br><span class="line">                    color = img.getpixel((y1, x1))</span><br><span class="line">                    plan.push(x, y, color)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">elif</span> <span class="keyword">not</span> is_in(x2, y2):</span><br><span class="line">                    color = img.getpixel((y2, x2))</span><br><span class="line">                    plan.push(x, y, color)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    POSITION_BLOCK = [(<span class="number">50</span>, <span class="number">50</span>), (<span class="number">50</span>, <span class="number">28</span>), (<span class="number">28</span>, <span class="number">50</span>), (<span class="number">28</span>, <span class="number">28</span>)]  <span class="comment"># 定位块</span></span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> POSITION_BLOCK:</span><br><span class="line">        <span class="keyword">for</span> x, y <span class="keyword">in</span> np.ndindex(<span class="number">5</span>, <span class="number">5</span>):</span><br><span class="line">            d = <span class="built_in">max</span>(<span class="built_in">abs</span>(x - <span class="number">2</span>), <span class="built_in">abs</span>(y - <span class="number">2</span>))</span><br><span class="line">            color = <span class="number">0</span> <span class="keyword">if</span> (d % <span class="number">2</span> == <span class="number">0</span>) <span class="keyword">else</span> <span class="number">255</span></span><br><span class="line">            plan.push(block[<span class="number">0</span>] + x - <span class="number">2</span>, block[<span class="number">1</span>] + y - <span class="number">2</span>, color)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> plan</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">iter_blocks</span>():</span><br><span class="line">    <span class="comment"># 枚举顺序从四周到中心，方便先利用已知数据</span></span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">        <span class="keyword">for</span> i, j <span class="keyword">in</span> np.ndindex(N, N):</span><br><span class="line">            dx = <span class="built_in">min</span>(i, (N - <span class="number">1</span>) - i)</span><br><span class="line">            dy = <span class="built_in">min</span>(j, (N - <span class="number">1</span>) - j)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">min</span>(dx, dy) == d:</span><br><span class="line">                <span class="keyword">yield</span> (j, i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    mosaic = Image.<span class="built_in">open</span>(<span class="string">'pixelated_qrcode.bmp'</span>)</span><br><span class="line">    temp = np.asarray(mosaic.copy(), dtype=<span class="string">'uint8'</span>)</span><br><span class="line"></span><br><span class="line">    plans = [ get_initial_plan(mosaic) ]</span><br><span class="line">    <span class="keyword">for</span> i, j <span class="keyword">in</span> iter_blocks():</span><br><span class="line">        new_plans = []</span><br><span class="line"></span><br><span class="line">        related_block = []</span><br><span class="line">        <span class="keyword">for</span> x, y <span class="keyword">in</span> np.ndindex(<span class="number">57</span>, <span class="number">57</span>):</span><br><span class="line">            <span class="keyword">if</span> check_qr_block_in(i, j, x, y):</span><br><span class="line">                related_block.append([x, y])</span><br><span class="line">        n = <span class="built_in">len</span>(related_block)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'Solving (<span class="subst">{i:<span class="number">2</span>}</span>, <span class="subst">{j:<span class="number">2</span>}</span>), related blocks: <span class="subst">{n}</span>'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span> ** n):</span><br><span class="line">            plan = Plan()</span><br><span class="line">            <span class="keyword">for</span> index, block <span class="keyword">in</span> <span class="built_in">enumerate</span>(related_block):</span><br><span class="line">                <span class="keyword">if</span> ((<span class="number">2</span> ** index) &amp; b) &gt; <span class="number">0</span>:</span><br><span class="line">                    paint_with(temp, *block, <span class="number">0</span>)</span><br><span class="line">                    plan.push(*block, <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    paint_with(temp, *block, <span class="number">255</span>)</span><br><span class="line">                    plan.push(*block, <span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">            color = calc_block_color(temp, i, j)</span><br><span class="line">            correct_color = mosaic.getpixel((Y + j * BOX_SIZE, X + i * BOX_SIZE))</span><br><span class="line">            <span class="keyword">if</span> color == correct_color:</span><br><span class="line">                <span class="keyword">for</span> old_plan <span class="keyword">in</span> plans:</span><br><span class="line">                    <span class="keyword">if</span> plan.compatible(old_plan):</span><br><span class="line">                        new_plans.append(old_plan.combine(plan))</span><br><span class="line"></span><br><span class="line">        plans = new_plans</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(plans) &gt; <span class="number">1000</span>:</span><br><span class="line">            ids = [ i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(plans)) ]</span><br><span class="line">            random.shuffle(ids)</span><br><span class="line">            buckets = []</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> ids[:<span class="number">1000</span>]:</span><br><span class="line">                buckets.append(plans[i])</span><br><span class="line">            plans = buckets</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(plans) == <span class="number">0</span>:  <span class="comment"># 如果 Failed 了，请洗把脸回来，再跑一遍</span></span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Failed'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 比较炫酷的调试输出</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>, <span class="number">52</span>):</span><br><span class="line">            <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>, <span class="number">55</span>):</span><br><span class="line">                <span class="keyword">if</span> (value := plans[<span class="number">0</span>].plan.get((x, y))) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    c = <span class="string">'*'</span> <span class="keyword">if</span> value == <span class="number">0</span> <span class="keyword">else</span> <span class="string">'_'</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    c = <span class="string">' '</span></span><br><span class="line">                <span class="built_in">print</span>(c, end=<span class="string">' '</span>)</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'Current valid plans: <span class="subst">{<span class="built_in">len</span>(plans)}</span>'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出 10 张复原的二维码</span></span><br><span class="line">    <span class="keyword">for</span> i, plan <span class="keyword">in</span> <span class="built_in">enumerate</span>(plans[:<span class="number">10</span>]):</span><br><span class="line">        <span class="keyword">for</span> (x, y), value <span class="keyword">in</span> plan.plan.items():</span><br><span class="line">            paint_with(temp, x, y, value)</span><br><span class="line">        image = Image.fromarray(temp, mode=<span class="string">'L'</span>)</span><br><span class="line">        image.save(<span class="string">f'result-<span class="subst">{i}</span>.bmp'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure>
<h1 id="minecraft">minecRaft</h1>
<p>打开网页，我们发现了一个微型 Minecraft 游戏，<del>然后就开始愉快的摸起鱼来</del>。</p>
<p>咳咳，这是一道 web 题，并且「本题解法与原版 Minecraft 游戏无关」。故 F12 打开，然后可以看到 html 内嵌的 js 中有这么一段：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cinput.<span class="property">length</span> &gt;= <span class="number">32</span>) {</span><br><span class="line">    <span class="keyword">let</span> tbool = <span class="title function_">gyflagh</span>(cinput.<span class="title function_">join</span>(<span class="string">''</span>));</span><br><span class="line">    <span class="keyword">if</span> (tbool) {</span><br><span class="line">        pressplateList[<span class="number">65</span>].<span class="title class_">TurnOn</span>_redstone_lamp();</span><br><span class="line">        content.<span class="property">innerText</span> = <span class="string">'Congratulations!!!'</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    cinput.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>并且 <code>gyflagh</code> 这个函数是定义在 <code>flag.js</code> 里面的，很难不猜测这就是最终涉及到 flag 的地方。</p>
<p>打开 <code>flag.js</code>，然后我们看到了一堆乱码…………</p>
<p>首先我们可以把 <code>0x</code> 打头的十六进制数转成十进制数，不然的话跟变量的命名很像，看着太瞎眼了。</p>
<p>然后观察一下参数是 <code>422</code> 到 <code>439</code> 之类的函数，可以发现都跟一个叫 <code>_0x2c9e</code> 的函数有关。</p>
<p>把这个 js 贴到 Devtools Console 里面，多执行几次，发现返回值不会变，并且都是 <code>charCodeAt</code>，<code>slice</code>, <code>fromCharCode</code> 这种函数名，不妨可以猜测这个函数只是一个 string mapping。所以我们就把这个 mapping 手动给它转回去。</p>
<p>替换完了之后，应该就只剩下变量名比较难看了。所以根据上下文，给这些变量换个名字。</p>
<p>这波操作下来之后，这个代码就好看了不少：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">String</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">encrypt</span> = <span class="keyword">function</span>(<span class="params">key_str</span>) {</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">2</span>), key = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">let</span> result = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">const</span> plaintext = <span class="built_in">escape</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        key[i] = <span class="title class_">Str4ToLong</span>(key_str.<span class="title function_">slice</span>(i * <span class="number">4</span>, (i + <span class="number">1</span>) * <span class="number">4</span>));</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; plaintext.<span class="property">length</span>; i += <span class="number">8</span>) {</span><br><span class="line">        arr[<span class="number">0</span>] = <span class="title class_">Str4ToLong</span>(plaintext.<span class="title function_">slice</span>(i    , i + <span class="number">4</span>));</span><br><span class="line">        arr[<span class="number">1</span>] = <span class="title class_">Str4ToLong</span>(plaintext.<span class="title function_">slice</span>(i + <span class="number">4</span>, i + <span class="number">8</span>));</span><br><span class="line">        <span class="title function_">code</span>(arr, key);</span><br><span class="line">        result += <span class="title class_">LongToBase16</span>(arr[<span class="number">0</span>]) + <span class="title class_">LongToBase16</span>(arr[<span class="number">1</span>]);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">code</span>(<span class="params">arr, key</span>) {</span><br><span class="line">    <span class="keyword">let</span> a = arr[<span class="number">0</span>], b = arr[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">STEP</span> = <span class="number">2654435769</span>, <span class="variable constant_">END</span> = <span class="variable constant_">STEP</span> * <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">let</span> cur = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (cur != <span class="variable constant_">END</span>) {</span><br><span class="line">        a += ((b &lt;&lt; <span class="number">4</span>) ^ (b &gt;&gt;&gt; <span class="number">5</span>)) + (b ^ cur) + key[cur &amp; <span class="number">3</span>];</span><br><span class="line">        cur += <span class="variable constant_">STEP</span>;</span><br><span class="line">        b += ((a &lt;&lt; <span class="number">4</span>) ^ (a &gt;&gt;&gt; <span class="number">5</span>)) + (a ^ cur) + key[(cur &gt;&gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>];</span><br><span class="line">    }</span><br><span class="line">    arr[<span class="number">0</span>] = a;</span><br><span class="line">    arr[<span class="number">1</span>] = b;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Str4ToLong</span>(<span class="params">val</span>) {</span><br><span class="line">    <span class="keyword">let</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        result |= val.<span class="title function_">charCodeAt</span>(i) &lt;&lt; (i * <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">isNaN</span>(result) ? <span class="number">0</span> : result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">LongToBase16</span>(<span class="params">val</span>) {</span><br><span class="line">    <span class="keyword">let</span> result = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">3</span>; i &gt;= <span class="number">0</span>; i--) {</span><br><span class="line">        <span class="keyword">let</span> tmp = ((val &gt;&gt; (<span class="number">8</span> * i)) &amp; <span class="number">0xff</span>)[<span class="string">'toString'</span>](<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">parseInt</span>(<span class="string">'0x'</span> + tmp) &lt;= <span class="number">0xf</span>)</span><br><span class="line">            tmp = <span class="string">'0'</span> + tmp;</span><br><span class="line">        result += tmp;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Base16ToLong</span>(<span class="params">str</span>) {</span><br><span class="line">    <span class="keyword">let</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i += <span class="number">2</span>) {</span><br><span class="line">        <span class="keyword">let</span> tmp = <span class="built_in">parseInt</span>(<span class="string">'0x'</span> + str.<span class="title function_">slice</span>(i, i + <span class="number">2</span>));</span><br><span class="line">        result = (result &lt;&lt; <span class="number">8</span>) + tmp;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">LongToStr4</span>(<span class="params">val</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(val &amp; <span class="number">0xff</span>, val &gt;&gt; <span class="number">8</span> &amp; <span class="number">0xff</span>, val &gt;&gt; <span class="number">16</span> &amp; <span class="number">0xff</span>, val &gt;&gt; <span class="number">24</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">gyflagh</span>(<span class="params">text</span>) {</span><br><span class="line">    <span class="keyword">let</span> encrypted = text.<span class="title function_">encrypt</span>(<span class="string">'1356853149054377'</span>);</span><br><span class="line">    <span class="keyword">return</span> encrypted === <span class="string">'6fbde674819a59bfa12092565b4ca2a7a11dc670c678681daf4afb6704b82f0c'</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>我们先把目光放在 <code>String.prototype.encrypt</code> 上，这个函数首先将 <code>key_str</code> 分成了 4 段（<code>1356 8531 4905 4377</code>），然后将每一段通过 <code>Str4ToLong</code> 转为整数。</p>
<p>接着，再把 <code>text</code>（64 个字符，每 8 个分一段）分成 4 段，每一段中再分成前后两个部分（不妨称为 a, b），然后把 a, b 扔给 <code>code</code> 做变换，再把变换后的 a, b <code>LongToBase16</code> 后加到 <code>result</code>（字符串）后面。</p>
<p>上面这段话可能有点难理解，拿 <code>gyflagh</code> 中的例子来说，假设 <code>text = "mInecRaft#-ls_900d_f0r_$ntEr1ain"</code>，就是：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">        Str4ToLong                   code                      LongToBase16</span><br><span class="line"></span><br><span class="line">mIne cRaf  -&gt;  1701726573 1717654115  --&gt;   1874716276 -2120590913  -&gt;  6fbde674 819a59bf</span><br><span class="line">t#-l s_90  -&gt;  1814897524 0809066355  --&gt;  -1591700906  1531749031  -&gt;  a1209256 5b4ca2a7</span><br><span class="line">0d_f 0r_$  -&gt;  1717527600 0610234928  --&gt;  -1591884176  -965187555  -&gt;  a11dc670 c678681d</span><br><span class="line">ntEr 1ain  -&gt;  1917154414 1852399921  --&gt;  -1354040473    79179532  -&gt;  af4afb67 04b82f0c</span><br></pre></td></tr></tbody></table></figure>
<p>但是实际上，<code>text</code> 是什么我们是不知道的，我们要用 <code>encrypted</code> 来反推 <code>text</code>，其关键显然在 <code>code</code> 这个函数中。</p>
<p>然后现在的话，我们要完成的目标就是（右边的数值可以用 <code>encrypted</code> 进行 <code>Base16ToLong</code> 得到）：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">code([?, ?], key)  -&gt;   1874716276 -2120590913</span><br><span class="line">code([?, ?], key)  -&gt;  -1591700906  1531749031</span><br><span class="line">code([?, ?], key)  -&gt;  -1591884176  -965187555</span><br><span class="line">code([?, ?], key)  -&gt;  -1354040473    79179532</span><br></pre></td></tr></tbody></table></figure>
<p>然后我们可以注意到，<code>code</code> 函数的计算是可逆的，可以通过最终的结果反推出输入的值。</p>
<p>于是随便写一个逆向程序：</p>
<figure class="highlight rust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> KEYS: [Wrapping&lt;<span class="type">u32</span>&gt;; <span class="number">4</span>] = [ <span class="title function_ invoke__">Wrapping</span>(<span class="number">909456177</span>), <span class="title function_ invoke__">Wrapping</span>(<span class="number">825439544</span>), <span class="title function_ invoke__">Wrapping</span>(<span class="number">892352820</span>), <span class="title function_ invoke__">Wrapping</span>(<span class="number">926364468</span>) ];</span><br><span class="line"><span class="keyword">const</span> ADD: Wrapping&lt;<span class="type">u32</span>&gt; = <span class="title function_ invoke__">Wrapping</span>(<span class="number">2654435769</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">uncode</span>(a: <span class="type">u32</span>, b: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> (<span class="type">u32</span>, <span class="type">u32</span>) {</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">val</span> = ADD * <span class="title function_ invoke__">Wrapping</span>(<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">a</span> = <span class="title function_ invoke__">Wrapping</span>(a);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">b</span> = <span class="title function_ invoke__">Wrapping</span>(b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">32</span> {</span><br><span class="line">        b -= ((a &lt;&lt; <span class="number">4</span>) ^ (a &gt;&gt; <span class="number">5</span>)) + a ^ val + KEYS[((val &gt;&gt; <span class="number">11</span>).<span class="number">0</span> &amp; <span class="number">3</span>) <span class="keyword">as</span> <span class="type">usize</span>];</span><br><span class="line">        val -= ADD;</span><br><span class="line">        a -= ((b &lt;&lt; <span class="number">4</span>) ^ (b &gt;&gt; <span class="number">5</span>)) + b ^ val + KEYS[(val.<span class="number">0</span> &amp; <span class="number">3</span>) <span class="keyword">as</span> <span class="type">usize</span>];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">return</span> (a.<span class="number">0</span>, b.<span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>然后就不难推算出 <code>code</code> 的输入是：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ 1700225869, 1598378594 ]</span><br><span class="line">[ 1817013865, 1098007406 ]</span><br><span class="line">[  861893681, 1601779041 ]</span><br><span class="line">[ 1967743793, 1765372015 ]</span><br></pre></td></tr></tbody></table></figure>
<p>然后再把这些值用 <code>LongToStr4</code> 拼回去，得到 <code>McWebRE_inMlnCrA1t_3a5y_1cIuop9i</code>。</p>
<h1 id="密码生成器">密码生成器</h1>
<p>运行密码生成器，发现并没有输入栏；并且能够感觉到，这道题是要“复现”输出。</p>
<p>然后，我们可以盲猜……这个程序的“输入”是，时间，精度大约是 1 秒。</p>
<p>然后的话，我们就可以把时间设置成 2021-09-22 23:11（也可以用 <a target="_blank" rel="noopener" href="https://www.nirsoft.net/utils/run_as_date.html">RunAsDate</a>）（感觉那个时区只是一个障眼法），然后生成一些密码，多试几个，就成了。</p>
<p>密码是 <code>$Z=CBDL7TjHu~mEX</code>，登入就能获取 flag 了。</p>
<p>顺带一说，为了更方便手操（cao 一声），我还弄了一个自动读剪贴板的东西，这样鼠标就只用点“生成”、“复制到剪贴板”了。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> win32clipboard</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">s = <span class="built_in">set</span>()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            win32clipboard.OpenClipboard()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception:  <span class="comment"># 上面的 OpenClipboard 有概率出错，盲猜是读写冲突了</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    data = win32clipboard.GetClipboardData()</span><br><span class="line">    win32clipboard.CloseClipboard()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">not</span> <span class="keyword">in</span> s:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f'new data: <span class="subst">{data}</span>'</span>)</span><br><span class="line">        s.add(data)</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br></pre></td></tr></tbody></table></figure>
<h1 id="just-be-fun">JUST BE FUN</h1>
<blockquote>
<p>写在前面：这道题有更好的解法，甚至可以两维完成。我这里的话，首先是当时也没想那么多，基本上是“能跑就行”，其次我以为交换只能交换栈顶两个数，这个就限制了很多可能。所以这个解法看个乐就行。</p>
</blockquote>
<p>说实话，这道题还是蛮有意思的。怎么说呢，看着自己写的指令在三维空间上执行，虽然实际上没有什么用，但是看起来炫酷就完事了。</p>
<p>这道题的大致意思就是，你可以在一个三维（256 * 256 * 256）的空间（可以看成是地址）上写程序（每个点能写一个指令），然后解析器会在上面跑。同时解析器会随机生成一个求值字符串，需要你编写一个能正确算出这个值的程序。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">指令</th>
<th style="text-align: center;">机器码</th>
<th style="text-align: center;">读取数</th>
<th style="text-align: center;">写入数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ADD_OP</td>
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td>将栈顶两个数相加</td>
</tr>
<tr class="even">
<td style="text-align: center;">SUB_OP</td>
<td style="text-align: center;"><code>-</code></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td>将栈顶两个数相减（栈顶为减数）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">MUL_OP</td>
<td style="text-align: center;"><code>*</code></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td>将栈顶两个数相乘</td>
</tr>
<tr class="even">
<td style="text-align: center;">DIV_OP</td>
<td style="text-align: center;"><code>/</code></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td>将栈顶两个数相除（栈顶为除数）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">MOD_OP</td>
<td style="text-align: center;"><code>%</code></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td>将栈顶两个数取模（栈顶为模数）</td>
</tr>
<tr class="even">
<td style="text-align: center;">NOT_OP</td>
<td style="text-align: center;"><code>!</code></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td>取非</td>
</tr>
<tr class="odd">
<td style="text-align: center;">CMP_OP</td>
<td style="text-align: center;"><code>`</code></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td>比较，栈顶小则 1，否则为 0</td>
</tr>
<tr class="even">
<td style="text-align: center;">X_U_OP</td>
<td style="text-align: center;"><code>&gt;</code></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td>向 x+ 运行</td>
</tr>
<tr class="odd">
<td style="text-align: center;">X_D_OP</td>
<td style="text-align: center;"><code>&lt;</code></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td>向 x- 运行</td>
</tr>
<tr class="even">
<td style="text-align: center;">Y_U_OP</td>
<td style="text-align: center;"><code>v</code></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td>向 y+ 运行</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Y_D_OP</td>
<td style="text-align: center;"><code>^</code></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td>向 y- 运行</td>
</tr>
<tr class="even">
<td style="text-align: center;">Z_U_OP</td>
<td style="text-align: center;"><code>[</code></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td>向 z+ 运行</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Z_D_OP</td>
<td style="text-align: center;"><code>]</code></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td>向 z- 运行</td>
</tr>
<tr class="even">
<td style="text-align: center;">X_JMP</td>
<td style="text-align: center;"><code>_</code></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td>若栈顶为 <code>True</code>，则向 x- 运行，反之亦然</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Y_JMP</td>
<td style="text-align: center;"><code>|</code></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td>若栈顶为 <code>True</code>，则向 y- 运行，反之亦然</td>
</tr>
<tr class="even">
<td style="text-align: center;">Z_JMP</td>
<td style="text-align: center;"><code>#</code></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td>若栈顶为 <code>True</code>，则向 z- 运行，反之亦然</td>
</tr>
<tr class="odd">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: center;"><code>"</code></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">n</td>
<td>将此处（不含 <code>"</code>）到下一个 <code>"</code> 之前的指令，都作为 ASCII 写入栈中</td>
</tr>
<tr class="even">
<td style="text-align: center;">DUP_OP</td>
<td style="text-align: center;"><code>:</code></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">2</td>
<td>将栈顶元素复制多一份</td>
</tr>
<tr class="odd">
<td style="text-align: center;">SWAP_OP</td>
<td style="text-align: center;"><code>\</code></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td>将两个指定位置的值交换（位置为相对于栈顶，不计这两个操作数，从 1 开始）</td>
</tr>
<tr class="even">
<td style="text-align: center;">POP_OP</td>
<td style="text-align: center;"><code>$</code></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td>弹出栈顶一个元素</td>
</tr>
<tr class="odd">
<td style="text-align: center;">NUM_OP</td>
<td style="text-align: center;"><code>.</code></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td>将栈顶作为数字写入 <code>result</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">CHR_OP</td>
<td style="text-align: center;"><code>,</code></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td>将栈顶作为 ASCII 写入 <code>result</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">INP_OP</td>
<td style="text-align: center;"><code>~</code></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td>读取 <code>input</code> 序列的下一个字符，为 ASCII 码</td>
</tr>
<tr class="even">
<td style="text-align: center;">END_OP</td>
<td style="text-align: center;"><code>@</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td>程序结束</td>
</tr>
<tr class="odd">
<td style="text-align: center;">NOP_OP</td>
<td style="text-align: center;"><code></code></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td>什么都不做（按照惯性继续向前）</td>
</tr>
</tbody>
</table>
<p>并且已知程序从 <code>[0, 0, 0]</code> 开始执行，方向为 <code>[1, 0, 0]</code>（x+）。</p>
<p>输入序列是像 <code>6*2|2*4&lt;2*6*1x7^4|3</code> 一类的字符串，运算符没有优先级（都是从左向右），数字都是 1 位数字。运算符具体含义如下：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">运算符</th>
<th style="text-align: center;">ASCII</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: center;">43</td>
<td style="text-align: left;">加法</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>*</code></td>
<td style="text-align: center;">42</td>
<td style="text-align: left;">乘法</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>^</code></td>
<td style="text-align: center;">94</td>
<td style="text-align: left;">幂运算</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>x</code></td>
<td style="text-align: center;">120</td>
<td style="text-align: left;">二进制异或（XOR）</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>|</code></td>
<td style="text-align: center;">124</td>
<td style="text-align: left;">二进制或（OR）</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>&lt;</code></td>
<td style="text-align: center;">60</td>
<td style="text-align: left;">二进制左移</td>
</tr>
</tbody>
</table>
<p>于是我们可以大致确定这个程序的框架：</p>
<ol type="1">
<li>先获取第一个数字，压入栈中，作为初始数值；</li>
<li>获取下一个输入（运算符），然后分发到不同的代码段中执行；</li>
<li>重复第 2 个操作，直到遇到 <code>\0</code>。</li>
</ol>
<p>于是我们可以设计这么一种 layout：</p>
<p><a href="/images/2021-10-30-Hackergame-2021/JustBeFun_layout.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/JustBeFun_layout.png" loading="lazy"></a></p>
<p>注意到运算符的顺序，按照 ASCII 来排序可以方便后面的比较操作（只需要比较 <code>&gt;</code> 一次就可以了，不用反过来再比一次）。</p>
<p>至于每一层，反正它给了 256 格高，我直接给每一层分配了 16 格的高度，让它们自由发挥，避免上下冲突。</p>
<p>下面我们来分别设计这些部分，目录：</p>
<ul>
<li><a href="#useful-patterns">Useful Patterns</a> (Pre-requisite knowledge)</li>
<li><a href="#program-entrypoint">Program Entrypoint</a></li>
<li><a href="#command-dispatcher-returner">Command Dispatcher &amp; Returner</a></li>
<li><a href="#binocular-operator">Binocular Operator (Add, Multiple)</a></li>
<li><a href="#power-and-shift-operator">Power and Shift Operator</a></li>
<li><a href="#bitwise-operator">Bitwise Operator (XOR, OR)</a></li>
</ul>
<h2 id="useful-patterns">Useful Patterns</h2>
<p>在开始之前，我们先定义一些常用操作的 patterns。</p>
<h3 id="比较栈顶位置与一个常数09">比较栈顶位置与一个常数（0~9）</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">指令</th>
<th style="text-align: left;">栈</th>
<th style="text-align: left;">备注</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: left;"><code>[ val ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">DUP_OP</td>
<td style="text-align: left;"><code>[ val, val ]</code></td>
<td style="text-align: left;">栈顶元素需要保留，而比较指令会消耗参数，故复制一份</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0~9</td>
<td style="text-align: left;"><code>[ val, val, 0~9 ]</code></td>
<td style="text-align: left;">需要比较的常数</td>
</tr>
<tr class="even">
<td style="text-align: center;">CMP_OP</td>
<td style="text-align: left;"><code>[ val, 0/1 ]</code></td>
<td style="text-align: left;">进行比较，并且把比较结果放到栈顶</td>
</tr>
<tr class="odd">
<td style="text-align: center;">...</td>
<td style="text-align: left;"><code>[ val ]</code></td>
<td style="text-align: left;">自定义跳转</td>
</tr>
<tr class="even">
<td style="text-align: center;">POP_OP</td>
<td style="text-align: left;"><code>[]</code></td>
<td style="text-align: left;"><strong>如果</strong>整个匹配过程结束（<code>val</code> 不再需要）</td>
</tr>
</tbody>
</table>
<h3 id="比较栈顶位置与一个常数超出-09">比较栈顶位置与一个常数（超出 0~9）</h3>
<p>如果范围超出了 0~9，就要考虑用字符串模式将比较常数压入栈中。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">指令</th>
<th style="text-align: left;">栈</th>
<th style="text-align: left;">备注</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: left;"><code>[ val ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">DUP_OP</td>
<td style="text-align: left;"><code>[ val, val ]</code></td>
<td style="text-align: left;">栈顶元素需要保留，而比较指令会消耗参数，故复制一份</td>
</tr>
<tr class="odd">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ val, val ]</code></td>
<td style="text-align: left;">进入字符串模式</td>
</tr>
<tr class="even">
<td style="text-align: center;">x</td>
<td style="text-align: left;"><code>[ val, val, 'x' ]</code></td>
<td style="text-align: left;">需要比较的常数（比 9 大的数可以找 ASCII 后面的字母）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: left;"><code>[ val, val, 'x', '0' ]</code></td>
<td style="text-align: left;">用来后面做减法</td>
</tr>
<tr class="even">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ val, val, 'x', '0' ]</code></td>
<td style="text-align: left;">退出字符串模式</td>
</tr>
<tr class="odd">
<td style="text-align: center;">SUB_OP</td>
<td style="text-align: left;"><code>[ val, val, x ]</code></td>
<td style="text-align: left;">减一下，获得真实数字</td>
</tr>
<tr class="even">
<td style="text-align: center;">CMP_OP</td>
<td style="text-align: left;"><code>[ val, 0/1 ]</code></td>
<td style="text-align: left;">进行比较，并且把比较结果放到栈顶</td>
</tr>
<tr class="odd">
<td style="text-align: center;">...</td>
<td style="text-align: left;"><code>[ val ]</code></td>
<td style="text-align: left;">自定义跳转</td>
</tr>
<tr class="even">
<td style="text-align: center;">POP_OP</td>
<td style="text-align: left;"><code>[]</code></td>
<td style="text-align: left;"><strong>如果</strong>整个匹配过程结束（<code>val</code> 不再需要）</td>
</tr>
</tbody>
</table>
<h3 id="比较栈顶位置与一个字符">比较栈顶位置与一个字符</h3>
<p>跟上一个相比，不用压入 <code>0</code> 了。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">指令</th>
<th style="text-align: left;">栈</th>
<th style="text-align: left;">备注</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: left;"><code>[ val ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">DUP_OP</td>
<td style="text-align: left;"><code>[ val, val ]</code></td>
<td style="text-align: left;">栈顶元素需要保留，而比较指令会消耗参数，故复制一份</td>
</tr>
<tr class="odd">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ val, val ]</code></td>
<td style="text-align: left;">进入字符串模式</td>
</tr>
<tr class="even">
<td style="text-align: center;">x</td>
<td style="text-align: left;"><code>[ val, val, 'x' ]</code></td>
<td style="text-align: left;">需要比较的字符</td>
</tr>
<tr class="odd">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ val, val, 'x' ]</code></td>
<td style="text-align: left;">退出字符串模式</td>
</tr>
<tr class="even">
<td style="text-align: center;">CMP_OP</td>
<td style="text-align: left;"><code>[ val, 0/1 ]</code></td>
<td style="text-align: left;">进行比较，并且把比较结果放到栈顶</td>
</tr>
<tr class="odd">
<td style="text-align: center;">...</td>
<td style="text-align: left;"><code>[ val ]</code></td>
<td style="text-align: left;">自定义跳转</td>
</tr>
<tr class="even">
<td style="text-align: center;">POP_OP</td>
<td style="text-align: left;"><code>[]</code></td>
<td style="text-align: left;"><strong>如果</strong>整个匹配过程结束（<code>val</code> 不再需要）</td>
</tr>
</tbody>
</table>
<h3 id="交换栈顶两个元素">交换栈顶两个元素</h3>
<p>因为我一开始以为只能交换栈顶两个元素，等到实现到最后才发现不是。反正无伤大雅，加两个操作数就完事了。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">指令</th>
<th style="text-align: left;">栈</th>
<th style="text-align: left;">备注</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: left;"><code>[ v1, v2 ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: left;"><code>[ v1, v2, 1 ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: left;"><code>[ v1, v2, 1, 2 ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">CMP_OP</td>
<td style="text-align: left;"><code>[ v2, v1 ]</code></td>
<td style="text-align: left;">观察 <code>be_fun.py</code> 代码，易得</td>
</tr>
</tbody>
</table>
<h2 id="program-entrypoint">Program Entrypoint</h2>
<p><a href="/images/2021-10-30-Hackergame-2021/JustBeFun_entrypoint.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/JustBeFun_entrypoint.png" loading="lazy"></a></p>
<p>如图所示，获取第一个数字然后减去 <code>0</code>，然后向上跳转，将控制权交给 Dispatcher。</p>
<p>注意到这里还有一个 Returner，其实只是复用了一下这个 <code>[</code> 字符，将 <code>[</code> 看成两部分共用的即可。</p>
<h2 id="command-dispatcher-returner">Command Dispatcher &amp; Returner</h2>
<blockquote>
<p>这一 section 的指令全部都是放在 <code>y=0</code> 中。</p>
</blockquote>
<p><a href="/images/2021-10-30-Hackergame-2021/JustBeFun_dispatcher_1.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/JustBeFun_dispatcher_1.png" loading="lazy"></a></p>
<p>左下角的地址，可以看作是新一轮运算执行的开始（后面 Returner 也会返回到这个位置）。</p>
<p>所以先获取这一轮的运算符，然后判断是不是 0，是 0 的话就写出结果，然后退出程序。</p>
<p>否则就向 z+ 运行，到对应 Command 的 layer 的时候，就比较一下运算符，比较成功就跳转进去（y+）。</p>
<p>比较器如下所示，其中 <code>+*^&lt;|x</code> 为这一层的 Command，根据情况安排：</p>
<p><a href="/images/2021-10-30-Hackergame-2021/JustBeFun_dispatcher_2.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/JustBeFun_dispatcher_2.png" loading="lazy"></a></p>
<p>至于 Returner 的话，我就直接在 <code>x=245, y=0</code> 的地方安排一条 Z_D_OP 的返回通道，指令运行完就跳到这个位置就行。</p>
<p>然后在 <code>z=0, y=0</code> 的地方，再安排一条返回 <code>[5, 0, 0]</code> 的 X_D_OP 通道（返回到 Entrypoint 的 from Returner 的地方，然后进入下一轮运算）</p>
<p>其实这个怎么搞也没有太大关系，先把标准弄好，后面对接的时候就会比较方便。</p>
<h2 id="binocular-operator">Binocular Operator</h2>
<p>加法和乘法比较简单，甚至指令都是一维的，就不画图了。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">指令</th>
<th style="text-align: left;">栈</th>
<th style="text-align: left;">备注</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: left;"><code>[ val ]</code></td>
<td style="text-align: left;">注意到运算符已经被提前 POP 出去了</td>
</tr>
<tr class="even">
<td style="text-align: center;">INP_OP</td>
<td style="text-align: left;"><code>[ val, 'x' ]</code></td>
<td style="text-align: left;">获取运算数</td>
</tr>
<tr class="odd">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ val, 'x' ]</code></td>
<td style="text-align: left;">进入字符串模式</td>
</tr>
<tr class="even">
<td style="text-align: center;">0</td>
<td style="text-align: left;"><code>[ val, 'x', '0' ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ val, 'x', '0' ]</code></td>
<td style="text-align: left;">退出字符串模式</td>
</tr>
<tr class="even">
<td style="text-align: center;">SUB_OP</td>
<td style="text-align: left;"><code>[ val, x ]</code></td>
<td style="text-align: left;">因为前面的 <code>x</code> 是字符，需要减一个 <code>0</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>+</code> or <code>*</code></td>
<td style="text-align: left;"><code>[ res ]</code></td>
<td style="text-align: left;">进行加法/乘法操作</td>
</tr>
</tbody>
</table>
<p>这堆操作搞完了之后，就直接导航到 <code>x=245, y=0</code> 处就不用管了（控制权交给 Returner）。</p>
<h2 id="power-and-shift-operator">Power and Shift Operator</h2>
<p>这一段的操作主要是左移和幂。思考一下，虽然可以写一个简单循环，但是仔细想一下，发现细节还是挺多的，于是我就换了一个思路。</p>
<p>考虑到操作数只有 1 到 9 的范围，所以可以把这些把这些情况分开考虑（分别安排电路）。</p>
<p>对于左移操作，如果要左移 <code>x</code> 位的话，等价于乘上 <code>x</code> 个 2，于是我们就可以先压入 <code>x</code> 个 2，再执行 <code>x</code> 次乘法操作。</p>
<p>对于幂运算，就是把当前的 <code>val</code> 复制出 <code>x</code> 份，然后再执行 <code>x - 1</code> 次乘法即可。</p>
<p><a href="/images/2021-10-30-Hackergame-2021/JustBeFun-shift.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/JustBeFun-shift.png" loading="lazy"></a></p>
<p>上面划出来点部分可以往后堆叠，<del>我本来想做成单片的，但是没做成</del>。注意到这里的 <code>n</code> 是从小到大（即 1~9）排的。</p>
<p>对于幂操作也类似，在中间竖条的地方改成 DUP_OP 和 MUL_OP（都是 <code>x - 1</code> 次）即可。</p>
<h2 id="bitwise-operator">Bitwise Operator</h2>
<p>这个位运算，我一开始在想，怎么用加减乘除模这些运算凑出来一个位运算啊。然后想不出来（也可能是我太菜了）。</p>
<p>如果不能凑的话，考虑到操作数只有 1~9，最多就是二进制的低 4 位，也就是说，对于左操作数，只用考虑它的低 4 位就行了（0~15）。</p>
<p>然后掐指一算，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9</mn><mo>×</mo><mn>16</mn><mo>=</mo><mn>144</mn></mrow><annotation encoding="application/x-tex">9 16 = 144</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">9</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">6</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mord">4</span></span></span></span>，感觉打个表完全可以接受啊，整个地址空间每维有 256 个长度，完全够用。</p>
<p>也就是说，我们首先要把左操作数的低 4 位提取出来，跟右操作数一起寻址（打表）（实际上为了方便起见，这两个部分分开寻址），然后找到结果之后再跟原数的高位结合，就可以了。</p>
<p>先把大框架搭起来，先把左操作数 <code>val</code> 拆成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn><mi>a</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">16a + b</annotation></semantics></math></span><span class="katex-html" data-aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">6</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span></span></span></span> 的形式（为了可读性，这里省略掉一些重复的部分）：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">指令</th>
<th style="text-align: left;">栈</th>
<th style="text-align: left;">备注</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: left;"><code>[ val ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">DUP_OP</td>
<td style="text-align: left;"><code>[ val, val ]</code></td>
<td style="text-align: left;">复制一份，毕竟要拆成两个数</td>
</tr>
<tr class="odd">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ val, val ]</code></td>
<td style="text-align: left;">进入字符串模式</td>
</tr>
<tr class="even">
<td style="text-align: center;">'0' + 16</td>
<td style="text-align: left;"><code>[ val, val, '@' ]</code></td>
<td style="text-align: left;">因为 16 超出了 0~9，只能这样干了</td>
</tr>
<tr class="odd">
<td style="text-align: center;">'0'</td>
<td style="text-align: left;"><code>[ val, val, '@', '0' ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ val, val, '@', '0' ]</code></td>
<td style="text-align: left;">退出字符串模式</td>
</tr>
<tr class="odd">
<td style="text-align: center;">SUB_OP</td>
<td style="text-align: left;"><code>[ val, val, 16 ]</code></td>
<td style="text-align: left;">减一下，获得真正的 16</td>
</tr>
<tr class="even">
<td style="text-align: center;">DIV_OP</td>
<td style="text-align: left;"><code>[ val, a ]</code></td>
<td style="text-align: left;">除一下，获得 <code>a</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">1, 2, SWAP_OP</td>
<td style="text-align: left;"><code>[ a, val ]</code></td>
<td style="text-align: left;">交换栈顶俩元素</td>
</tr>
<tr class="even">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ a, val ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">*</td>
<td style="text-align: left;"><code>[ a, val, 16 ]</code></td>
<td style="text-align: left;">自行用 STR 压入 16（参考上面）</td>
</tr>
<tr class="even">
<td style="text-align: center;">MOD_OP</td>
<td style="text-align: left;"><code>[ a, b ]</code></td>
<td style="text-align: left;">模一下，获得 <code>b</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">... (P1)</td>
<td style="text-align: left;"><code>[ a ]</code></td>
<td style="text-align: left;">把 <code>b</code> 拿去匹配（寻址）</td>
</tr>
<tr class="even">
<td style="text-align: center;">INP_OP</td>
<td style="text-align: left;"><code>[ a, 'x' ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">*</td>
<td style="text-align: left;"><code>[ a, x ]</code></td>
<td style="text-align: left;">自行减 <code>0</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">... (P2)</td>
<td style="text-align: left;"><code>[ a ]</code></td>
<td style="text-align: left;">把 <code>x</code> 拿去匹配</td>
</tr>
<tr class="odd">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ a ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">'0' + r</td>
<td style="text-align: left;"><code>[ a, 'r' ]</code></td>
<td style="text-align: left;">打表结果</td>
</tr>
<tr class="odd">
<td style="text-align: center;">'0'</td>
<td style="text-align: left;"><code>[ a, 'r', '0' ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">STR_OP</td>
<td style="text-align: left;"><code>[ a, 'r', '0' ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">SUB_OP</td>
<td style="text-align: left;"><code>[ a, r ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">...</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">这里可以先返回，后面的内容可以复用</td>
</tr>
<tr class="odd">
<td style="text-align: center;">1, 2, SWAP_OP</td>
<td style="text-align: left;"><code>[ r, a ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">*</td>
<td style="text-align: left;"><code>[ r, a, 16 ]</code></td>
<td style="text-align: left;">自行用 STR 压入 16（参考上面）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">MUL_OP</td>
<td style="text-align: left;"><code>[ r, a * 16 ]</code></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">ADD_OP</td>
<td style="text-align: left;"><code>[ a * 16 + r ]</code></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>然后把子 dispatcher（P1、P2）写好就行了。由于打表，2 个变量就要用掉 2 维，还有一维要放匹配完后执行的指令，所以以下三维灵魂抽象画警告。</p>
<figure>
<a href="/images/2021-10-30-Hackergame-2021/JustBeFun_bitwise_layout.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/JustBeFun_bitwise_layout.png" alt="" loading="lazy"></a><figcaption>Layout</figcaption>
</figure>
<figure>
<a href="/images/2021-10-30-Hackergame-2021/JustBeFun_bitwise_p1.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/JustBeFun_bitwise_p1.png" alt="" loading="lazy"></a><figcaption>P1</figcaption>
</figure>
<figure>
<a href="/images/2021-10-30-Hackergame-2021/JustBeFun_bitwise_p2.png" class="glightbox"><img src="/images/2021-10-30-Hackergame-2021/JustBeFun_bitwise_p2.png" alt="" loading="lazy"></a><figcaption>P2</figcaption>
</figure>
<p>大概就是这个样子，相信大家都能看懂吧（）。</p>
<p>最后把所有的部分拼起来，就成了。代码呢，就是这个样子：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">TOKEN = <span class="string">'1:MEQCIBY0ubN3BOXYsuRdXzqWIWNf8Jx0Y6giZCSp/Rg8zdNwAiBMZGWaiIGLD33KTfQ5TTLejp9PwGp8Gg4HsJbdo8sVig=='</span></span><br><span class="line"></span><br><span class="line">ADD_OP = <span class="string">'+'</span></span><br><span class="line">SUB_OP = <span class="string">'-'</span></span><br><span class="line">MUL_OP = <span class="string">'*'</span></span><br><span class="line">DIV_OP = <span class="string">'/'</span></span><br><span class="line">MOD_OP = <span class="string">'%'</span></span><br><span class="line">CMP_OP = <span class="string">'`'</span></span><br><span class="line">X_U_OP = <span class="string">'&gt;'</span></span><br><span class="line">X_D_OP = <span class="string">'&lt;'</span></span><br><span class="line">Y_D_OP = <span class="string">'^'</span></span><br><span class="line">Y_U_OP = <span class="string">'v'</span></span><br><span class="line">Z_U_OP = <span class="string">'['</span></span><br><span class="line">Z_D_OP = <span class="string">']'</span></span><br><span class="line">X_JMP = <span class="string">'_'</span></span><br><span class="line">Z_JMP = <span class="string">'#'</span></span><br><span class="line">STR_OP = <span class="string">'\"'</span></span><br><span class="line">DUP_OP = <span class="string">':'</span></span><br><span class="line">SWAP_OP = <span class="string">'\\'</span></span><br><span class="line">POP_OP = <span class="string">'$'</span></span><br><span class="line">NUM_OP = <span class="string">'.'</span></span><br><span class="line">INP_OP = <span class="string">'~'</span></span><br><span class="line">END_OP = <span class="string">'@'</span></span><br><span class="line">NOP_OP = <span class="string">' '</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">NUM</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">chr</span>(x + <span class="built_in">ord</span>(<span class="string">'0'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">board = [[[<span class="string">'@'</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>)] <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>)] <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>)]</span><br><span class="line"></span><br><span class="line">BLOCK_START = <span class="number">0x20</span></span><br><span class="line">BLOCK_HEIGHT = <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">SUB_COMMAND = {</span><br><span class="line">    <span class="string">'*'</span>: BLOCK_START + BLOCK_HEIGHT * <span class="number">1</span>, <span class="comment"># 42</span></span><br><span class="line">    <span class="string">'+'</span>: BLOCK_START + BLOCK_HEIGHT * <span class="number">2</span>, <span class="comment"># 43</span></span><br><span class="line">    <span class="string">'&lt;'</span>: BLOCK_START + BLOCK_HEIGHT * <span class="number">3</span>, <span class="comment"># 60</span></span><br><span class="line">    <span class="string">'^'</span>: BLOCK_START + BLOCK_HEIGHT * <span class="number">4</span>, <span class="comment"># 94</span></span><br><span class="line">    <span class="string">'x'</span>: BLOCK_START + BLOCK_HEIGHT * <span class="number">5</span>, <span class="comment"># 120</span></span><br><span class="line">    <span class="string">'|'</span>: BLOCK_START + BLOCK_HEIGHT * <span class="number">6</span>, <span class="comment"># 124</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_init</span>():</span><br><span class="line">    <span class="keyword">for</span> (i, c) <span class="keyword">in</span> <span class="built_in">enumerate</span>([INP_OP, STR_OP, <span class="string">'0'</span>, STR_OP, SUB_OP, Z_U_OP]):</span><br><span class="line">        board[i][<span class="number">0</span>][<span class="number">0</span>] = c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_command_dispatcher</span>():</span><br><span class="line">    board[ <span class="number">5</span>][<span class="number">0</span>][<span class="number">1</span>] = X_U_OP</span><br><span class="line">    board[ <span class="number">6</span>][<span class="number">0</span>][<span class="number">1</span>] = INP_OP</span><br><span class="line">    board[ <span class="number">7</span>][<span class="number">0</span>][<span class="number">1</span>] = DUP_OP</span><br><span class="line">    board[ <span class="number">8</span>][<span class="number">0</span>][<span class="number">1</span>] = NUM(<span class="number">0</span>)</span><br><span class="line">    board[ <span class="number">9</span>][<span class="number">0</span>][<span class="number">1</span>] = CMP_OP</span><br><span class="line">    board[<span class="number">10</span>][<span class="number">0</span>][<span class="number">1</span>] = Z_U_OP</span><br><span class="line">    board[<span class="number">10</span>][<span class="number">0</span>][<span class="number">2</span>] = X_JMP</span><br><span class="line">    board[ <span class="number">9</span>][<span class="number">0</span>][<span class="number">2</span>] = Z_U_OP</span><br><span class="line"></span><br><span class="line">    board[<span class="number">11</span>][<span class="number">0</span>][<span class="number">2</span>] = POP_OP</span><br><span class="line">    board[<span class="number">12</span>][<span class="number">0</span>][<span class="number">2</span>] = NUM_OP</span><br><span class="line">    board[<span class="number">13</span>][<span class="number">0</span>][<span class="number">2</span>] = END_OP</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> z <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, <span class="number">0x100</span>):</span><br><span class="line">        board[ <span class="number">9</span>][<span class="number">0</span>][z] = NOP_OP</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (cmd, pos) <span class="keyword">in</span> SUB_COMMAND.items():</span><br><span class="line">        <span class="keyword">for</span> (i, c) <span class="keyword">in</span> <span class="built_in">enumerate</span>([DUP_OP, STR_OP, cmd, STR_OP, CMP_OP]):</span><br><span class="line">            board[<span class="number">9</span>][<span class="number">0</span>][pos - (<span class="number">5</span> - i)] = c</span><br><span class="line">        board[<span class="number">9</span>][<span class="number">0</span>][pos] = X_JMP</span><br><span class="line">        board[<span class="number">10</span>][<span class="number">0</span>][pos] = POP_OP</span><br><span class="line">        board[<span class="number">11</span>][<span class="number">0</span>][pos] = Y_U_OP</span><br><span class="line">        board[<span class="number">8</span>][<span class="number">0</span>][pos] = Z_U_OP</span><br><span class="line">        board[<span class="number">8</span>][<span class="number">0</span>][pos + <span class="number">1</span>] = X_U_OP</span><br><span class="line">        board[<span class="number">9</span>][<span class="number">0</span>][pos + <span class="number">1</span>] = Z_U_OP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_returner</span>():</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>( <span class="number">6</span>, <span class="number">0x100</span>):</span><br><span class="line">        board[x][<span class="number">0</span>][<span class="number">0</span>] = X_D_OP</span><br><span class="line">    <span class="keyword">for</span> z <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x100</span>):</span><br><span class="line">        board[<span class="number">0x100</span> - <span class="number">10</span>][<span class="number">0</span>][z] = Z_D_OP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_binocular_operator</span>(<span class="params">cmd, op</span>):</span><br><span class="line">    Z_BASE = SUB_COMMAND[cmd]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i, c) <span class="keyword">in</span> <span class="built_in">enumerate</span>([X_U_OP, INP_OP, STR_OP, NUM(<span class="number">0</span>), STR_OP, SUB_OP, op]):</span><br><span class="line">        board[<span class="number">11</span> + i][<span class="number">1</span>][Z_BASE] = c</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>, <span class="number">0x100</span>):</span><br><span class="line">        board[x][<span class="number">1</span>][Z_BASE] = NOP_OP</span><br><span class="line">    board[<span class="number">0x100</span> - <span class="number">10</span>][<span class="number">1</span>][Z_BASE] = Y_D_OP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_pow_operator</span>():</span><br><span class="line">    Z_BASE = SUB_COMMAND[<span class="string">'^'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i, c) <span class="keyword">in</span> <span class="built_in">enumerate</span>([NOP_OP, INP_OP, STR_OP, NUM(<span class="number">0</span>), STR_OP, SUB_OP]):</span><br><span class="line">        board[<span class="number">11</span>][i + <span class="number">1</span>][Z_BASE] = c</span><br><span class="line"></span><br><span class="line">    board[<span class="number">11</span>][<span class="number">7</span>][Z_BASE] = X_D_OP</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">9</span> + <span class="number">1</span>):</span><br><span class="line">        y = (i - <span class="number">1</span>) * <span class="number">2</span> + <span class="number">7</span></span><br><span class="line">        board[<span class="number">10</span>][y    ][Z_BASE] = DUP_OP</span><br><span class="line">        board[ <span class="number">9</span>][y    ][Z_BASE] = NUM(i)</span><br><span class="line">        board[ <span class="number">8</span>][y    ][Z_BASE] = Y_U_OP</span><br><span class="line">        board[ <span class="number">8</span>][y + <span class="number">1</span>][Z_BASE] = X_U_OP</span><br><span class="line">        board[ <span class="number">9</span>][y + <span class="number">1</span>][Z_BASE] = CMP_OP</span><br><span class="line">        board[<span class="number">10</span>][y + <span class="number">1</span>][Z_BASE] = NOP_OP</span><br><span class="line">        board[<span class="number">11</span>][y + <span class="number">1</span>][Z_BASE] = Y_U_OP</span><br><span class="line">        board[<span class="number">11</span>][y + <span class="number">2</span>][Z_BASE] = X_JMP</span><br><span class="line">        board[<span class="number">12</span>][y + <span class="number">2</span>][Z_BASE] = POP_OP</span><br><span class="line"></span><br><span class="line">        x = <span class="number">13</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i - <span class="number">1</span>):</span><br><span class="line">            board[x][y + <span class="number">2</span>][Z_BASE] = DUP_OP</span><br><span class="line">            x += <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i - <span class="number">1</span>):</span><br><span class="line">            board[x][y + <span class="number">2</span>][Z_BASE] = MUL_OP</span><br><span class="line">            x += <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> x &lt; <span class="number">0x100</span>:</span><br><span class="line">            board[x][y + <span class="number">2</span>][Z_BASE] = NOP_OP</span><br><span class="line">            x += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x100</span>):</span><br><span class="line">        board[<span class="number">0x100</span> - <span class="number">10</span>][y][Z_BASE] = Y_D_OP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_shift_operator</span>():</span><br><span class="line">    Z_BASE = SUB_COMMAND[<span class="string">'&lt;'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i, c) <span class="keyword">in</span> <span class="built_in">enumerate</span>([NOP_OP, INP_OP, STR_OP, NUM(<span class="number">0</span>), STR_OP, SUB_OP]):</span><br><span class="line">        board[<span class="number">11</span>][i + <span class="number">1</span>][Z_BASE] = c</span><br><span class="line"></span><br><span class="line">    board[<span class="number">11</span>][<span class="number">7</span>][Z_BASE] = X_D_OP</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">9</span> + <span class="number">1</span>):</span><br><span class="line">        y = (i - <span class="number">1</span>) * <span class="number">2</span> + <span class="number">7</span></span><br><span class="line">        board[<span class="number">10</span>][y    ][Z_BASE] = DUP_OP</span><br><span class="line">        board[ <span class="number">9</span>][y    ][Z_BASE] = NUM(i)</span><br><span class="line">        board[ <span class="number">8</span>][y    ][Z_BASE] = Y_U_OP</span><br><span class="line">        board[ <span class="number">8</span>][y + <span class="number">1</span>][Z_BASE] = X_U_OP</span><br><span class="line">        board[ <span class="number">9</span>][y + <span class="number">1</span>][Z_BASE] = CMP_OP</span><br><span class="line">        board[<span class="number">10</span>][y + <span class="number">1</span>][Z_BASE] = NOP_OP</span><br><span class="line">        board[<span class="number">11</span>][y + <span class="number">1</span>][Z_BASE] = Y_U_OP</span><br><span class="line">        board[<span class="number">11</span>][y + <span class="number">2</span>][Z_BASE] = X_JMP</span><br><span class="line">        board[<span class="number">12</span>][y + <span class="number">2</span>][Z_BASE] = POP_OP</span><br><span class="line"></span><br><span class="line">        x = <span class="number">13</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i):</span><br><span class="line">            board[x][y + <span class="number">2</span>][Z_BASE] = NUM(<span class="number">2</span>)</span><br><span class="line">            x += <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i):</span><br><span class="line">            board[x][y + <span class="number">2</span>][Z_BASE] = MUL_OP</span><br><span class="line">            x += <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> x &lt; <span class="number">0x100</span>:</span><br><span class="line">            board[x][y + <span class="number">2</span>][Z_BASE] = NOP_OP</span><br><span class="line">            x += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x100</span>):</span><br><span class="line">        board[<span class="number">0x100</span> - <span class="number">10</span>][y][Z_BASE] = Y_D_OP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_bitwise_operator</span>(<span class="params">cmd, calc</span>):</span><br><span class="line">    Z_BASE = SUB_COMMAND[cmd]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i, c) <span class="keyword">in</span> <span class="built_in">enumerate</span>([DUP_OP, STR_OP, NUM(<span class="number">16</span>), NUM(<span class="number">0</span>), STR_OP, SUB_OP, DIV_OP, NUM(<span class="number">1</span>), NUM(<span class="number">2</span>), SWAP_OP,</span><br><span class="line">                             STR_OP, NUM(<span class="number">16</span>), NUM(<span class="number">0</span>), STR_OP, SUB_OP, MOD_OP]):</span><br><span class="line">        board[<span class="number">11</span>][i + <span class="number">1</span>][Z_BASE] = c</span><br><span class="line"></span><br><span class="line">    board[<span class="number">11</span>][<span class="number">17</span>][Z_BASE] = X_D_OP</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        y = i * <span class="number">2</span> + <span class="number">17</span></span><br><span class="line">        board[<span class="number">10</span>][y][Z_BASE] = DUP_OP</span><br><span class="line">        board[ <span class="number">9</span>][y][Z_BASE] = STR_OP</span><br><span class="line">        board[ <span class="number">8</span>][y][Z_BASE] = NUM(i)</span><br><span class="line">        board[ <span class="number">7</span>][y][Z_BASE] = NUM(<span class="number">0</span>)</span><br><span class="line">        board[ <span class="number">6</span>][y][Z_BASE] = STR_OP</span><br><span class="line">        board[ <span class="number">5</span>][y][Z_BASE] = Y_U_OP</span><br><span class="line">        board[ <span class="number">5</span>][y + <span class="number">1</span>][Z_BASE] = X_U_OP</span><br><span class="line">        board[ <span class="number">6</span>][y + <span class="number">1</span>][Z_BASE] = SUB_OP</span><br><span class="line">        board[ <span class="number">7</span>][y + <span class="number">1</span>][Z_BASE] = CMP_OP</span><br><span class="line">        board[ <span class="number">8</span>][y + <span class="number">1</span>][Z_BASE] = NOP_OP</span><br><span class="line">        board[ <span class="number">9</span>][y + <span class="number">1</span>][Z_BASE] = NOP_OP</span><br><span class="line">        board[<span class="number">10</span>][y + <span class="number">1</span>][Z_BASE] = NOP_OP</span><br><span class="line">        board[<span class="number">11</span>][y + <span class="number">1</span>][Z_BASE] = Y_U_OP</span><br><span class="line">        board[<span class="number">11</span>][y + <span class="number">2</span>][Z_BASE] = X_JMP</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i, c) <span class="keyword">in</span> <span class="built_in">enumerate</span>([POP_OP, INP_OP, STR_OP, NUM(<span class="number">0</span>), STR_OP, SUB_OP]):</span><br><span class="line">            board[<span class="number">12</span> + i][y + <span class="number">2</span>][Z_BASE] = c</span><br><span class="line"></span><br><span class="line">        y_base = y + <span class="number">2</span></span><br><span class="line">        board[<span class="number">18</span>][y_base][Z_BASE] = Z_D_OP</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">9</span> + <span class="number">1</span>):</span><br><span class="line">            x = (j - <span class="number">1</span>) * <span class="number">2</span> + (<span class="number">18</span>)</span><br><span class="line">            board[x    ][y_base][Z_BASE - <span class="number">1</span>] = DUP_OP</span><br><span class="line">            board[x    ][y_base][Z_BASE - <span class="number">2</span>] = NUM(j)</span><br><span class="line">            board[x    ][y_base][Z_BASE - <span class="number">3</span>] = X_U_OP</span><br><span class="line">            board[x + <span class="number">1</span>][y_base][Z_BASE - <span class="number">3</span>] = Z_U_OP</span><br><span class="line">            board[x + <span class="number">1</span>][y_base][Z_BASE - <span class="number">2</span>] = CMP_OP</span><br><span class="line">            board[x + <span class="number">1</span>][y_base][Z_BASE - <span class="number">1</span>] = NOP_OP</span><br><span class="line">            board[x + <span class="number">1</span>][y_base][Z_BASE    ] = X_U_OP</span><br><span class="line">            board[x + <span class="number">2</span>][y_base][Z_BASE    ] = Z_JMP</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i, c) <span class="keyword">in</span> <span class="built_in">enumerate</span>([POP_OP, STR_OP, NUM(calc(i, j)), NUM(<span class="number">0</span>), STR_OP, SUB_OP]):</span><br><span class="line">                board[x + <span class="number">2</span>][y_base][Z_BASE + <span class="number">1</span> + i] = c</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>, <span class="number">0x100</span>):</span><br><span class="line">            board[x][y_base][Z_BASE + <span class="number">7</span>] = X_U_OP</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x100</span>):</span><br><span class="line">        board[<span class="number">0x100</span> - <span class="number">10</span>][y][Z_BASE + <span class="number">7</span>] = Y_D_OP</span><br><span class="line">    <span class="keyword">for</span> (i, c) <span class="keyword">in</span> <span class="built_in">enumerate</span>([NUM(<span class="number">1</span>), NUM(<span class="number">2</span>), SWAP_OP, STR_OP, NUM(<span class="number">16</span>), NUM(<span class="number">0</span>), STR_OP, SUB_OP, MUL_OP, ADD_OP]):</span><br><span class="line">        board[<span class="number">0x100</span> - <span class="number">10</span>][<span class="number">10</span> - i][Z_BASE + <span class="number">7</span>] = c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_board</span>():</span><br><span class="line">    board_list = []</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">            <span class="keyword">for</span> z <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">                <span class="keyword">if</span> board[x][y][z] != END_OP:</span><br><span class="line">                    b = <span class="built_in">ord</span>(board[x][y][z])</span><br><span class="line">                    board_list.append(<span class="string">f'(<span class="subst">{x}</span>, <span class="subst">{y}</span>, <span class="subst">{z}</span>) -&gt; <span class="subst">{b}</span>'</span>)</span><br><span class="line"></span><br><span class="line">    board_list.append(<span class="string">'END'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">' '</span>.join(board_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">submit</span>():</span><br><span class="line">    c = remote(<span class="string">'202.38.93.111'</span>, <span class="number">10104</span>)</span><br><span class="line">    result = get_board()</span><br><span class="line">    c.recv()</span><br><span class="line">    c.sendline(TOKEN)</span><br><span class="line">    c.recv()</span><br><span class="line">    c.sendline(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(c.recvline())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    load_init()</span><br><span class="line">    load_command_dispatcher()</span><br><span class="line">    load_returner()</span><br><span class="line"></span><br><span class="line">    load_binocular_operator(<span class="string">'+'</span>, ADD_OP)</span><br><span class="line">    load_binocular_operator(<span class="string">'*'</span>, MUL_OP)</span><br><span class="line">    load_pow_operator()</span><br><span class="line">    load_shift_operator()</span><br><span class="line">    load_bitwise_operator(<span class="string">'|'</span>, <span class="keyword">lambda</span> x, y: x | y)</span><br><span class="line">    load_bitwise_operator(<span class="string">'x'</span>, <span class="keyword">lambda</span> x, y: x ^ y)</span><br><span class="line"></span><br><span class="line">    submit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure>
<h1 id="pq">p😭q</h1>
<p>这道题本质上就是<del>如何用眼看音乐</del>，是把频谱图转换为声波。</p>
<p>我本来以为这道题还要手撕 FFT 的，结果发现完全不用，首先给了代码，再者[见下文]，于是这道题就完全是一道工程题，只要会调库就可以了。</p>
<p>看源码，源码大致可以分成两个部分：正向 FFT，和 gif 生成。</p>
<p>我们就反过来“逆向”每一步就行了。</p>
<p>首先是读 gif，这个没啥好说的，只是细节比较多，直接上代码（趴）：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">'flag.gif'</span>)</span><br><span class="line"></span><br><span class="line">db_frames = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, gif_frame <span class="keyword">in</span> <span class="built_in">enumerate</span>(ImageSequence.Iterator(image)):</span><br><span class="line">    <span class="comment"># 将 gif_frame 转为 [x, y, 3] 的三维数组</span></span><br><span class="line">    frame = np.asarray(</span><br><span class="line">            gif_frame.convert(<span class="string">'RGB'</span>).getdata(),</span><br><span class="line">            dtype=np.uint8</span><br><span class="line">        ).reshape(gif_frame.size[<span class="number">1</span>], gif_frame.size[<span class="number">0</span>], <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    dbs = []  <span class="comment"># 该 frame 中，频率对应的 dB</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> freq <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, num_freqs):</span><br><span class="line">        <span class="keyword">for</span> i, threshold <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">list</span>(<span class="built_in">range</span>(min_db, max_db + <span class="number">1</span>, quantize))[::-<span class="number">1</span>], start=<span class="number">1</span>):</span><br><span class="line">            x = threshold - min_db</span><br><span class="line">            y = (freq * <span class="number">2</span> + <span class="number">1</span>) * <span class="number">2</span></span><br><span class="line">            color = frame[x][y]</span><br><span class="line">            <span class="keyword">if</span> (color == white_pixel).<span class="built_in">all</span>():</span><br><span class="line">                dbs.append(i - <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    db_frames.append(dbs)</span><br></pre></td></tr></tbody></table></figure>
<p>随后就是要逆向这个 <code>melspectrogram</code>。看源代码：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spectrogram = (</span><br><span class="line">    numpy.around(</span><br><span class="line">        librosa.power_to_db(</span><br><span class="line">            librosa.feature.melspectrogram(</span><br><span class="line">                ...</span><br><span class="line">            )</span><br><span class="line">        ) / quantize</span><br><span class="line">    ) * quantize</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<p>最外层，<code>/ quantize</code>, <code>numpy.around</code>, <code>* quantize</code> 就是将 dB 取整。</p>
<p>然后再里面一层，就是 <code>librosa.power_to_db</code>，看这个命名……盲猜一下……大概有个函数……可以把它反过来，还真有：<code>librosa.db_to_power</code>。</p>
<p>再里面一层，就是 FFT 大头，<code>librosa.feature.melspectrogram</code>，本来呢，我还做好准备要手撕 FFT 的，然后一查文档，发现好家伙，这函数也有逆函数 <code>librosa.feature.inverse.mel_to_audio</code>，这就省事了。</p>
<p>接下来的事就是把上面的过程反过来套一遍就可以了：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">db_frames = [ ... ]  <span class="comment"># 上面的 db_frames</span></span><br><span class="line"></span><br><span class="line">frames = np.array(db_frames).transpose(<span class="number">1</span>, <span class="number">0</span>)  <span class="comment"># 交换两维，我也不知道为啥要这样，反正接口要对上就对了</span></span><br><span class="line">frames += min_db</span><br><span class="line"><span class="comment"># 如果考虑上面的对 2 取整的话，实际上还要加上期望值 1 才对？</span></span><br><span class="line"></span><br><span class="line">y = librosa.feature.inverse.mel_to_audio(</span><br><span class="line">    librosa.db_to_power(frames),</span><br><span class="line">    <span class="number">22050</span>,  <span class="comment"># sample_rate</span></span><br><span class="line">    n_fft=fft_window_size,</span><br><span class="line">    hop_length=frame_step_size,</span><br><span class="line">    window=window_function_type</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sf.write(<span class="string">'origin.wav'</span>, y, <span class="number">22050</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>至此，我们就把 gif 逆向成了 <code>origin.wav</code>。</p>
<p>音频是「The flag is, F-L-A-G, 634,971,243,582」（数字是英语数字的读法）。</p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2022/07/11/COMPASS-2022S/">PREV</a><a class="next" href="/2020/11/11/Minecraft-seed-cracking/">NEXT</a></div><div class="copyright"><p>© 2017 - 2023 <a href="https://blog.monadx.com">Monad</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.defer=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer',"GTM-PP344KH");</script><script src="/js/all.min.js" defer></script></body></html>